# LifeOS Sync æŠ€æœ¯æ¶æ„è¯¦è§£

## ç‰ˆæœ¬è¯´æ˜

**å½“å‰ç‰ˆæœ¬**: v0.4.3 (2026-01-24)

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† LifeOS Sync æ’ä»¶çš„å®Œæ•´æŠ€æœ¯æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š
- **v0.4.3**: åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶ + è®¾å¤‡æ ‡è¯†ç®¡ç†
- **v0.4.x**: è·¨è®¾å¤‡ç¼“å­˜å…¼å®¹æ€§ + Bugä¿®å¤ + æµè§ˆå™¨ç¯å¢ƒé€‚é…
- **v0.3.0**: å¢é‡åŒæ­¥å¼•æ“ + è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨ + æ€§èƒ½ä¼˜åŒ–
- **v0.2.0**: ç¼“å­˜ç³»ç»Ÿ + å“ˆå¸Œç®—æ³•
- **v0.1.0**: åŸºç¡€å¯¼å‡ºåŠŸèƒ½

## ç›®å½•
1. [v0.4.3 åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶](#v043-åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶)
2. [v0.4.x æ–°å¢åŠŸèƒ½ä¸ä¿®å¤](#v04x-æ–°å¢åŠŸèƒ½ä¸ä¿®å¤)
2. [v0.3.0 æ–°å¢æ¶æ„](#v030-æ–°å¢æ¶æ„)
   - [å¢é‡åŒæ­¥å¼•æ“](#å¢é‡åŒæ­¥å¼•æ“)
   - [è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨](#è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨)
   - [æ€§èƒ½ä¼˜åŒ–åˆ†æ](#æ€§èƒ½ä¼˜åŒ–åˆ†æ)
3. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
4. [å“ˆå¸Œç®—æ³•è¯¦è§£](#å“ˆå¸Œç®—æ³•è¯¦è§£)
5. [ç¼“å­˜ç³»ç»Ÿæ¶æ„](#ç¼“å­˜ç³»ç»Ÿæ¶æ„)
6. [åŒæ­¥æµç¨‹è¯¦è§£](#åŒæ­¥æµç¨‹è¯¦è§£)
7. [åˆ†å¸ƒå¼åŒæ­¥æœºåˆ¶](#åˆ†å¸ƒå¼åŒæ­¥æœºåˆ¶)
8. [æ—¶åºå›¾](#æ—¶åºå›¾)
9. [æ•°æ®ç»“æ„è¯¦è§£](#æ•°æ®ç»“æ„è¯¦è§£)
10. [è¾¹ç•Œæƒ…å†µå¤„ç†](#è¾¹ç•Œæƒ…å†µå¤„ç†)
11. [å·²çŸ¥æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å·²çŸ¥æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## v0.4.3 åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶

### é—®é¢˜èƒŒæ™¯

**åœºæ™¯**ï¼šç”¨æˆ·åœ¨å¤šä¸ªè®¾å¤‡ä¸Šä½¿ç”¨æ€æºç¬”è®°ï¼š
- Desktop ç«¯ï¼ˆWindowsï¼‰
- Docker ç«¯ï¼ˆ24/7 è¿è¡Œï¼‰
- Mobile ç«¯ï¼ˆæ‰‹æœºã€iPadï¼‰
- Browser tabsï¼ˆå¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µï¼‰

æ‰€æœ‰è®¾å¤‡éƒ½å¯ç”¨è‡ªåŠ¨åŒæ­¥ï¼ˆ10-30 åˆ†é’Ÿé—´éš”ï¼‰ï¼Œå¯¼è‡´ï¼š
1. **å¹¶å‘å†™å…¥å†²çª**ï¼šå¤šä¸ªè®¾å¤‡åŒæ—¶å‘ GitHub å†™å…¥åŒä¸€æ–‡ä»¶
2. **SHA æ ¡éªŒå¤±è´¥**ï¼šGitHub è¿”å› 409 Conflict
3. **ç¼“å­˜ä¸ä¸€è‡´**ï¼šä¸åŒè®¾å¤‡çš„æœ¬åœ°ç¼“å­˜å¯èƒ½ä¸åŒæ­¥

### è§£å†³æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åˆ†å¸ƒå¼åŒæ­¥é”æµç¨‹ (v0.4.3)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    è®¾å¤‡ A                    GitHub                    è®¾å¤‡ B
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è§¦å‘   â”‚              â”‚        â”‚                â”‚ è§¦å‘   â”‚
    â”‚ åŒæ­¥   â”‚              â”‚        â”‚                â”‚ åŒæ­¥   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚        â”‚                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                   â”‚        â”‚                    â”‚
        â–¼                   â”‚        â”‚                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. æ£€æŸ¥é”   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤ .sync- â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 1. æ£€æŸ¥é”   â”‚
    â”‚    æ–‡ä»¶     â”‚        â”‚ in-    â”‚            â”‚    æ–‡ä»¶     â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ progressâ”‚           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚        â”‚                   â”‚
          â–¼                â”‚        â”‚                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. æ£€æŸ¥     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤ commitsâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 2. æ£€æŸ¥     â”‚
    â”‚ commitæ—¶é—´  â”‚        â”‚        â”‚            â”‚ commitæ—¶é—´  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚        â”‚                   â”‚
          â”‚ æ— å†²çª         â”‚        â”‚         æœ‰å†²çª    â”‚
          â–¼                â”‚        â”‚                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. ç­‰å¾…     â”‚        â”‚        â”‚            â”‚ è·³è¿‡åŒæ­¥    â”‚
    â”‚ Jitter(0-15s)â”‚       â”‚        â”‚            â”‚ (æ˜¾ç¤ºåŸå› )  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚        â”‚
          â–¼                â”‚        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
    â”‚ 4. äºŒæ¬¡æ£€æŸ¥ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚
          â”‚                â”‚        â”‚
          â”‚ æ— å†²çª         â”‚        â”‚
          â–¼                â”‚        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
    â”‚ 5. åˆ›å»ºé”   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚        â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚
          â”‚                â”‚        â”‚
          â–¼                â”‚        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
    â”‚ 6. æ‰§è¡ŒåŒæ­¥ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ docs/  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ assets/â”‚
          â”‚                â”‚        â”‚
          â–¼                â”‚        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
    â”‚ 7. é‡Šæ”¾é”   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ åˆ é™¤   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ .sync- â”‚
                           â”‚ in-    â”‚
                           â”‚ progressâ”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. è®¾å¤‡æ ‡è¯†ç®¡ç† (`device-manager.ts`)

**å…³é”®è®¾è®¡å†³ç­–**ï¼šä½¿ç”¨ `localStorage` è€Œé `plugin.saveData()`

```typescript
// âŒ é”™è¯¯æ–¹å¼ï¼šplugin.saveData() ä¼šè¢« SiYuan åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡
await plugin.saveData('device-id.json', { deviceId: 'xxx' });
// ç»“æœï¼šæ‰€æœ‰è®¾å¤‡å…±äº«åŒä¸€ä¸ª deviceIdï¼Œå¤±å»å”¯ä¸€æ ‡è¯†æ„ä¹‰

// âœ… æ­£ç¡®æ–¹å¼ï¼šlocalStorage æ˜¯æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¼šè¢«åŒæ­¥
localStorage.setItem('lifeos-sync-device-id', deviceId);
// ç»“æœï¼šæ¯ä¸ªè®¾å¤‡æœ‰ç‹¬ç«‹çš„ deviceId
```

**ä¸»è¦å‡½æ•°**ï¼š
- `getDeviceId()`: è·å–æˆ–ç”Ÿæˆè®¾å¤‡ UUID
- `getDeviceName()`: è·å–è®¾å¤‡åç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- `setDeviceName()`: è®¾ç½®è®¾å¤‡åç§°
- `regenerateDeviceId()`: é‡æ–°ç”Ÿæˆè®¾å¤‡ ID
- `getShortDeviceId()`: è·å–çŸ­ IDï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

#### 2. é”æ–‡ä»¶æ ¼å¼ (`.sync-in-progress`)

```json
{
  "deviceId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "deviceName": "Desktop-Windows",
  "startTime": 1706000000000,
  "startTimeReadable": "2026-01-24 15:30:45 (UTC+8)",
  "ttl": 600000,
  "expiresAt": 1706000600000,
  "expiresAtReadable": "2026-01-24 15:40:45 (UTC+8)"
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `deviceId`: è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰
- `deviceName`: è®¾å¤‡åç§°ï¼ˆç”¨æˆ·å¯è¯»ï¼‰
- `startTime`: é”åˆ›å»ºæ—¶é—´æˆ³
- `startTimeReadable`: äººç±»å¯è¯»çš„å¼€å§‹æ—¶é—´ï¼ˆUTC+8ï¼‰
- `ttl`: é”è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `expiresAt`: é”è¿‡æœŸæ—¶é—´æˆ³
- `expiresAtReadable`: äººç±»å¯è¯»çš„è¿‡æœŸæ—¶é—´

#### 3. åŒæ­¥é”æ¨¡å— (`sync-lock.ts`)

**ä¸»è¦å‡½æ•°**ï¼š

```typescript
// è·å–é”çŠ¶æ€
async function getSyncLock(settings: Settings): Promise<SyncLockInfo | null>

// åˆ›å»ºé”
async function createSyncLock(settings: Settings, lockSettings: SyncLockSettings): Promise<boolean>

// é‡Šæ”¾é”
async function releaseSyncLock(settings: Settings): Promise<boolean>

// å®Œæ•´é”è·å–æµç¨‹
async function acquireSyncLock(
  settings: Settings,
  lockSettings: SyncLockSettings,
  onStatus?: (message: string) => void,
  onCountdown?: (remaining: number) => void
): Promise<SyncLockCheckResult>

// è·å–æœ€è¿‘ commit æ—¶é—´
async function getLastCommitTime(settings: Settings): Promise<number>
```

### é…ç½®é€‰é¡¹

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|-------|------|--------|
| `syncLock.enabled` | å¯ç”¨åˆ†å¸ƒå¼é” | `true` |
| `syncLock.lockTtl` | é”è¶…æ—¶æ—¶é—´ | `600000` (10åˆ†é’Ÿ) |
| `syncLock.firstCheckThreshold` | ç¬¬ä¸€æ¬¡æ£€æŸ¥é˜ˆå€¼ | `600000` (10åˆ†é’Ÿ) |
| `syncLock.secondCheckThreshold` | äºŒæ¬¡æ£€æŸ¥é˜ˆå€¼ | `300000` (5åˆ†é’Ÿ) |
| `syncLock.jitterRange` | éšæœºç­‰å¾…èŒƒå›´ | `15000` (15ç§’) |

### åŒæ­¥å†³ç­–é€»è¾‘

```typescript
async function acquireSyncLock(...): Promise<SyncLockCheckResult> {
  // 1. ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼šé”æ–‡ä»¶ + commit æ—¶é—´
  const existingLock = await getSyncLock(settings);

  if (existingLock && existingLock.deviceId !== myDeviceId) {
    if (Date.now() < existingLock.expiresAt) {
      // å…¶ä»–è®¾å¤‡æ­£åœ¨åŒæ­¥ï¼Œæœªè¿‡æœŸ
      return { canSync: false, reason: `${existingLock.deviceName} is syncing` };
    }
    // é”å·²è¿‡æœŸï¼Œå¯ä»¥è¦†ç›–
  }

  const lastCommitTime = await getLastCommitTime(settings);
  if (Date.now() - lastCommitTime < firstCheckThreshold) {
    // æœ€è¿‘æœ‰äººåŒæ­¥è¿‡
    return { canSync: false, reason: `Last sync ${minutes}m ago` };
  }

  // 2. éšæœºç­‰å¾… (Jitter)
  const jitter = calculateJitter(deviceId, jitterRange);
  await waitWithCountdown(jitter, onCountdown);

  // 3. äºŒæ¬¡æ£€æŸ¥ (æ›´çŸ­çš„é˜ˆå€¼)
  const lastCommitTime2 = await getLastCommitTime(settings);
  if (Date.now() - lastCommitTime2 < secondCheckThreshold) {
    // æœ‰äººåœ¨ jitter æœŸé—´åŒæ­¥äº†
    return { canSync: false, reason: `Someone synced during jitter` };
  }

  // 4. åˆ›å»ºé”æ–‡ä»¶
  await createSyncLock(settings, lockSettings);

  return { canSync: true };
}
```

### Jitter ç®—æ³•

**ç›®çš„**ï¼šé¿å…å¤šä¸ªè®¾å¤‡åŒæ—¶é€šè¿‡æ£€æŸ¥ååŒæ—¶å°è¯•åˆ›å»ºé”

```typescript
function calculateJitter(deviceId: string, jitterRange: number): number {
  // åŸºäº deviceId çš„ç¨³å®šå“ˆå¸Œ
  let hash = 0;
  for (let i = 0; i < deviceId.length; i++) {
    const char = deviceId.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }

  // æ˜ å°„åˆ° jitterRange (0-15ç§’)
  return Math.abs(hash) % jitterRange;
}
```

**ç‰¹ç‚¹**ï¼š
- åŒä¸€è®¾å¤‡æ¯æ¬¡çš„ jitter ç›¸å¯¹ç¨³å®š
- ä¸åŒè®¾å¤‡ä¹‹é—´æœ‰å·®å¼‚
- é¿å…å®Œå…¨éšæœºå¯¼è‡´çš„ä¸ç¡®å®šæ€§

### çŠ¶æ€æ åé¦ˆ

| çŠ¶æ€ | æ˜¾ç¤ºå†…å®¹ | è¯´æ˜ |
|------|---------|------|
| æ£€æŸ¥é” | `ğŸ” Checking sync lock...` | æ­£åœ¨æ£€æŸ¥é”çŠ¶æ€ |
| è¢«é˜»æ­¢ | `â¸ï¸ Desktop-Win is syncing (8m 30s)` | å…¶ä»–è®¾å¤‡æ­£åœ¨åŒæ­¥ |
| æœ€è¿‘åŒæ­¥ | `â¸ï¸ Last sync 5m ago (threshold: 10m)` | æœ€è¿‘æœ‰äººåŒæ­¥è¿‡ |
| ç­‰å¾… | `â³ Waiting to sync... (12s)` | Jitter å€’è®¡æ—¶ |
| è·å–é” | `ğŸ”’ Acquiring sync lock...` | æ­£åœ¨åˆ›å»ºé”æ–‡ä»¶ |
| åŒæ­¥ä¸­ | `ğŸ”„ Syncing docs... ğŸ“„ (5/20)` | åŒæ­¥è¿›è¡Œä¸­ |
| å®Œæˆ | `âœ… Sync complete: 18 docs, 5 assets (4.2s)` | åŒæ­¥æˆåŠŸ |
| å¤±è´¥ | `âŒ Sync failed: Network error` | åŒæ­¥å¤±è´¥ |
| å¼ºåˆ¶åŒæ­¥ | `âš ï¸ Force sync in progress...` | å¼ºåˆ¶åŒæ­¥ä¸­ |

### å¼ºåˆ¶åŒæ­¥åŠŸèƒ½

**ä½¿ç”¨åœºæ™¯**ï¼š
- é”æ–‡ä»¶å› è®¾å¤‡å´©æºƒé—ç•™
- éœ€è¦ç´§æ€¥åŒæ­¥
- è°ƒè¯•/æµ‹è¯•

**å®‰å…¨æœºåˆ¶**ï¼š
- éœ€è¦è¾“å…¥ "yes" ç¡®è®¤
- ä¼šè¦†ç›–ç°æœ‰é”
- æ—¥å¿—è®°å½•å¼ºåˆ¶åŒæ­¥æ“ä½œ

```typescript
async function performForceSyncWithLock(...): Promise<LockedSyncResult> {
  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  const confirmed = await showForceConfirmDialog();
  if (!confirmed) return { executed: false, skippedReason: 'Cancelled' };

  // å¼ºåˆ¶åˆ›å»ºé”ï¼ˆè¦†ç›–ç°æœ‰ï¼‰
  await createSyncLock(settings, lockSettings);

  // æ‰§è¡ŒåŒæ­¥
  const result = await performIncrementalSync(...);

  // é‡Šæ”¾é”
  await releaseSyncLock(settings);

  return { executed: true, result };
}
```

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/device-manager.ts` | è®¾å¤‡æ ‡è¯†ç®¡ç†ï¼ˆlocalStorageï¼‰ |
| `src/sync-lock.ts` | åˆ†å¸ƒå¼é”æœºåˆ¶ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `src/types.ts` | æ·»åŠ  `SyncLockConfig` æ¥å£ |
| `src/settings.ts` | æ·»åŠ é»˜è®¤é”é…ç½®ï¼Œä¿®å¤æ·±åº¦åˆå¹¶ |
| `src/ui.ts` | æ·»åŠ é”çŠ¶æ€æ˜¾ç¤ºå‡½æ•°ï¼Œç¡®è®¤å¯¹è¯æ¡† |
| `src/incremental-sync.ts` | æ·»åŠ  `performIncrementalSyncWithLock()` |
| `src/auto-sync-scheduler.ts` | ä½¿ç”¨å¸¦é”çš„åŒæ­¥å‡½æ•° |
| `src/index.ts` | è®¾ç½®ç•Œé¢æ·»åŠ è®¾å¤‡/é”é…ç½® |

---

## v0.4.x æ–°å¢åŠŸèƒ½ä¸ä¿®å¤

### v0.4.2 (2026-01-23) - æµè§ˆå™¨ç¯å¢ƒå…¼å®¹æ€§ä¿®å¤

#### é—®é¢˜èƒŒæ™¯

åœ¨å®é™…ä½¿ç”¨ä¸­å‘ç°ï¼Œæ‰€æœ‰æ–°ä¸Šä¼ çš„ assets éƒ½ä¼šå¤±è´¥ï¼ŒæŠ¥é”™ï¼š`Buffer is not defined`ã€‚

**æ ¹æœ¬åŸå› **ï¼š
```typescript
// assets-sync.ts (é”™è¯¯ä»£ç )
const githubSHA = await uploadFileToGitHub(
  Buffer.from(content),  // âŒ æµè§ˆå™¨ç¯å¢ƒæ²¡æœ‰ Node.js çš„ Buffer
  githubPath,
  settings
);

async function uploadFileToGitHub(
  content: Buffer,  // âŒ æœŸæœ› Node.js Buffer
  path: string,
  settings: Settings
): Promise<string> {
  const result = await createOrUpdateBinaryFile(
    { ... },
    content.buffer  // âŒ å°è¯•è®¿é—® .buffer å±æ€§
  );
}
```

SiYuan æ’ä»¶è¿è¡Œåœ¨**æµè§ˆå™¨ç¯å¢ƒ**ï¼Œä¸æ”¯æŒ Node.js çš„ `Buffer` APIã€‚

#### è§£å†³æ–¹æ¡ˆ

ç›´æ¥ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ `ArrayBuffer`ï¼š

```typescript
// assets-sync.ts (ä¿®å¤å)
const githubSHA = await uploadFileToGitHub(
  content,  // âœ… ç›´æ¥ä¼ é€’ ArrayBuffer
  githubPath,
  settings
);

async function uploadFileToGitHub(
  content: ArrayBuffer,  // âœ… ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿç±»å‹
  path: string,
  settings: Settings
): Promise<string> {
  const result = await createOrUpdateBinaryFile(
    { ... },
    content  // âœ… ç›´æ¥ä¼ é€’ ArrayBuffer
  );
}
```

**ä¿®å¤å½±å“**ï¼š
- âœ… æ–° assets ç°åœ¨å¯ä»¥æ­£å¸¸ä¸Šä¼ 
- âœ… å…¼å®¹æ‰€æœ‰æµè§ˆå™¨ç¯å¢ƒï¼ˆDesktopã€Dockerã€Mobileï¼‰

---

### v0.4.1 (2026-01-23) - å›¾ç‰‡é“¾æ¥æ ¼å¼ä¿®å¤

#### é—®é¢˜èƒŒæ™¯

ç”¨æˆ·åé¦ˆå¯¼å‡ºçš„ markdown ä¸­ï¼Œéƒ¨åˆ†å›¾ç‰‡é“¾æ¥å‡ºç°åŒå¹å·ï¼š
```markdown
!![image](../assets/image-20250123113938-mpmpxjp.png)
```

è¿™å¯¼è‡´å›¾ç‰‡åœ¨ GitHub/VSCode ä¸­æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚

**æ ¹æœ¬åŸå› **ï¼š

```typescript
// exporter.ts:276 (é”™è¯¯ä»£ç )
markdown = markdown.replace(/\[([^\]]*?)\]\((\.\.\/assets\/[^)]+)\)/g, '![$1]($2)');
```

è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¼šåŒ¹é…**æ‰€æœ‰** `[text](../assets/...)` æ ¼å¼çš„é“¾æ¥ï¼ŒåŒ…æ‹¬å·²ç»æœ‰ `!` çš„ï¼š
- `[image](../assets/...)` â†’ `![image](../assets/...)` âœ…
- `![image](../assets/...)` ä¸­çš„ `[image](../assets/...)` â†’ `!![image](../assets/...)` âŒ

#### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨**è´Ÿå‘åé¡¾æ–­è¨€ (Negative Lookbehind)** æ£€æŸ¥å‰é¢æ˜¯å¦å·²æœ‰å¹å·ï¼š

```typescript
// exporter.ts:277 (ä¿®å¤å)
markdown = markdown.replace(/(?<!!)\[([^\]]*?)\]\((\.\.\/assets\/[^)]+)\)/g, '![$1]($2)');
//                           ^^^^^^
//                           åªåŒ¹é…å‰é¢æ²¡æœ‰ ! çš„é“¾æ¥
```

**æ­£åˆ™è¯¦è§£**ï¼š
- `(?<!!)`: è´Ÿå‘åé¡¾æ–­è¨€ï¼Œç¡®ä¿å‰é¢ä¸æ˜¯ `!`
- `\[([^\]]*?)\]`: åŒ¹é… `[æ–‡æœ¬]`
- `\((\.\.\/assets\/[^)]+)\)`: åŒ¹é… `(../assets/è·¯å¾„)`

**ä¿®å¤å½±å“**ï¼š
- âœ… å·²æœ‰ `!` çš„å›¾ç‰‡é“¾æ¥ä¸ä¼šå†æ·»åŠ 
- âœ… æ²¡æœ‰ `!` çš„å›¾ç‰‡é“¾æ¥æ­£ç¡®æ·»åŠ 
- âœ… æ”¯æŒå¤šæ¬¡é‡æ–°å¯¼å‡ºåŒä¸€æ–‡æ¡£

---

### v0.4.0 (2026-01-23) - è·¨è®¾å¤‡ç¼“å­˜å…¼å®¹æ€§

#### é—®é¢˜èƒŒæ™¯

**åœºæ™¯**ï¼šç”¨æˆ·åœ¨å¤šä¸ªè®¾å¤‡ä¸Šä½¿ç”¨ LifeOS Syncï¼š
- Desktop ç«¯ï¼ˆWindowsï¼‰ï¼šä¸Šä¼ äº† 2352 ä¸ª assetsï¼Œç¼“å­˜æ–‡ä»¶å·²ç”Ÿæˆ
- Docker ç«¯ï¼šé€šè¿‡ SiYuan è‡ªå¸¦çš„åŒæ­¥åŠŸèƒ½ï¼Œç¼“å­˜æ–‡ä»¶å·²åŒæ­¥åˆ° Docker
- **é—®é¢˜**ï¼šDocker ç«¯ä»ç„¶æŠ¥å‘Šæ‰€æœ‰ 2352 ä¸ª assets ä¸º "New asset (no cache)"ï¼Œæƒ³è¦é‡æ–°ä¸Šä¼ 

**æ—¥å¿—è¯æ®**ï¼š
```
[Cache] Asset shard 7 loaded successfully (162 entries)
[Cache] Asset cache MISS: image-20251015200910-cgm837m.png (shard 4) - NOT found in 162 entries
```

ç¼“å­˜æ–‡ä»¶æ˜æ˜æœ‰è¿™ä¸ªæ–‡ä»¶ï¼ˆåœ¨ `assets-7.json`ï¼‰ï¼Œä½†æ’ä»¶åœ¨ `assets-4.json` ä¸­æŸ¥æ‰¾ï¼Œå¯¼è‡´ cache missã€‚

#### æ ¹æœ¬åŸå› 

**Shard è®¡ç®—ä¸ä¸€è‡´**ï¼š

```typescript
// cache-manager.ts
async function getAssetShard(assetPath: string): Promise<number> {
  const hash = await calculateShardHash(assetPath);
  return parseInt(hash.substring(0, 2), 16) % 16;
}
```

ä¸åŒç¯å¢ƒä¸‹ï¼Œ`calculateShardHash()` å¯èƒ½äº§ç”Ÿä¸åŒç»“æœï¼š
- Desktop ç«¯ï¼šSHA-256 â†’ `"a3c8f9e2..."` â†’ shard 7
- Docker ç«¯ï¼ˆHTTPï¼‰ï¼šFNV-1a â†’ `"b4d1a8c3"` â†’ shard 4

#### è§£å†³æ–¹æ¡ˆ 1: å¤š Shard æ‰«æç­–ç•¥

```typescript
// cache-manager.ts - getAssetCacheEntry()
export async function getAssetCacheEntry(
  plugin: Plugin,
  assetPath: string
): Promise<AssetCacheEntry | null> {
  // 1. å…ˆå°è¯•è®¡ç®—çš„ shardï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
  const expectedShard = await getAssetShard(assetPath);
  const expectedCache = await loadAssetCacheShard(plugin, expectedShard);

  if (expectedCache[assetPath]) {
    await logInfo(`[Cache] Asset cache HIT: ${assetPath} (shard ${expectedShard})`);
    return expectedCache[assetPath];
  }

  // 2. å¦‚æœåœ¨è®¡ç®—çš„ shard ä¸­æ²¡æ‰¾åˆ°ï¼Œæ‰«ææ‰€æœ‰å…¶ä»– shardï¼ˆå…¼å®¹è·¯å¾„ï¼‰
  await logInfo(`[Cache] Asset not found in expected shard ${expectedShard}, scanning all shards...`);

  for (let shard = 0; shard < ASSET_SHARD_COUNT; shard++) {
    if (shard === expectedShard) continue; // å·²ç»æŸ¥è¿‡äº†

    const cache = await loadAssetCacheShard(plugin, shard);
    if (cache[assetPath]) {
      await logInfo(`[Cache] Asset cache HIT: ${assetPath} (found in shard ${shard}, expected ${expectedShard})`);
      return cache[assetPath];
    }
  }

  // 3. æ‰€æœ‰ shard éƒ½æ²¡æ‰¾åˆ°
  await logInfo(`[Cache] Asset cache MISS: ${assetPath} - NOT found in any of ${ASSET_SHARD_COUNT} shards`);
  return null;
}
```

**ç­–ç•¥ç‰¹ç‚¹**ï¼š
1. **å¿«é€Ÿè·¯å¾„**ï¼šä¼˜å…ˆæŸ¥æ‰¾è®¡ç®—çš„ shardï¼ˆ99% å‘½ä¸­ï¼‰
2. **å…¼å®¹è·¯å¾„**ï¼šæŸ¥æ‰¾å¤±è´¥æ—¶æ‰«ææ‰€æœ‰ 16 ä¸ª shardsï¼ˆ1% è§¦å‘ï¼‰
3. **æ€§èƒ½å½±å“**ï¼šæå°ï¼ˆä»…åœ¨è·¨è®¾å¤‡é¦–æ¬¡åŒæ­¥æ—¶è§¦å‘ï¼Œä¹‹åç¼“å­˜æ›´æ–°åæ¢å¤å¿«é€Ÿè·¯å¾„ï¼‰

#### è§£å†³æ–¹æ¡ˆ 2: ç®€åŒ–ç¼“å­˜éªŒè¯é€»è¾‘

**ä¹‹å‰çš„é€»è¾‘**ï¼š
```typescript
const cached = await getAssetCacheEntry(plugin, asset.path);

if (cached && cached.fileSize === asset.size && cached.contentHash === expectedHash) {
  // ç¼“å­˜å‘½ä¸­
}
```

**é—®é¢˜**ï¼š`fileSize` å’Œ `contentHash` å¯èƒ½å› ä¸ºè·¨è®¾å¤‡è€Œä¸ä¸€è‡´ï¼ˆå¦‚æ—§ç‰ˆæœ¬ç¼“å­˜æœ‰ `fileSize: 0`ï¼‰ã€‚

**ä¿®å¤å**ï¼š
```typescript
// assets-sync.ts - uploadAssetWithCache()
const cached = await getAssetCacheEntry(plugin, asset.path);

if (cached) {
  // åªè¦ç¼“å­˜ä¸­æœ‰è®°å½•ï¼Œå°±ç›¸ä¿¡å·²ç»ä¸Šä¼ è¿‡ï¼Œä¸åšä»»ä½•éªŒè¯
  onProgress?.(`[Cache Hit] ${asset.path} - skipping (cached)`);
  return false; // Skip upload
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… é¿å…è·¨è®¾å¤‡ç¼“å­˜å­—æ®µä¸ä¸€è‡´é—®é¢˜
- âœ… ç®€åŒ–é€»è¾‘ï¼Œæå‡æ€§èƒ½
- âœ… å…¼å®¹ä¸åŒç‰ˆæœ¬çš„ç¼“å­˜æ–‡ä»¶

---

## v0.3.0 æ–°å¢æ¶æ„

### å¢é‡åŒæ­¥å¼•æ“

#### è®¾è®¡ç›®æ ‡

è§£å†³å¤§è§„æ¨¡ç¬”è®°åº“ï¼ˆ2000+ æ–‡æ¡£ã€5000+ èµ„æºï¼‰çš„è‡ªåŠ¨åŒæ­¥æ€§èƒ½é—®é¢˜ï¼š

**æ ¸å¿ƒæŒ‘æˆ˜**:
- æ¯æ¬¡è‡ªåŠ¨åŒæ­¥éƒ½å…¨é‡å¯¼å‡º markdown â†’ è€—æ—¶ 100s+
- æ¯æ¬¡éƒ½è®¡ç®—æ‰€æœ‰æ–‡ä»¶å“ˆå¸Œ â†’ CPU å ç”¨ 30%+
- æ¯æ¬¡éƒ½æŸ¥è¯¢ GitHub SHA â†’ ç½‘ç»œè¯·æ±‚ 7000+

**è§£å†³æ–¹æ¡ˆ**:
- åŸºäº SiYuan æ—¶é—´æˆ³çš„å˜åŒ–æ£€æµ‹
- SQL API æ‰¹é‡å…ƒæ•°æ®æŸ¥è¯¢
- ä»…å¤„ç†å˜åŒ–çš„æ–‡æ¡£å’Œèµ„æº

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¢é‡åŒæ­¥å¼•æ“æ¶æ„ (v0.3.0)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Trigger Event  â”‚
                    â”‚  (Auto/Manual)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Incremental    â”‚
                    â”‚  Sync Engine    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Document      â”‚  â”‚   Asset    â”‚  â”‚   Upload    â”‚
    â”‚  Scanner       â”‚  â”‚  Scanner   â”‚  â”‚  Executor   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚               â”‚
            â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SQL Metadata  â”‚  â”‚   File     â”‚  â”‚  Parallel   â”‚
    â”‚  Query         â”‚  â”‚   mtime    â”‚  â”‚  Batch(5)   â”‚
    â”‚  (All Docs)    â”‚  â”‚  Check     â”‚  â”‚  Processing â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Timestamp     â”‚  â”‚  Timestamp â”‚  â”‚  GitHub API â”‚
    â”‚  Comparison    â”‚  â”‚ Comparison â”‚  â”‚  PUT/GET    â”‚
    â”‚  Filter        â”‚  â”‚  Filter    â”‚  â”‚  Requests   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    Update Cache & Metadata    â”‚
            â”‚  - doc.siyuanUpdated          â”‚
            â”‚  - asset.mtime                â”‚
            â”‚  - GitHub SHA                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ–‡æ¡£æ‰«ææµç¨‹

**é˜¶æ®µ 1: SQL æ‰¹é‡å…ƒæ•°æ®æŸ¥è¯¢**

```typescript
// æ–‡ä»¶: incremental-sync.ts - getAllDocMetadata()

// å•æ¬¡ API è°ƒç”¨è·å–æ‰€æœ‰æ–‡æ¡£å…ƒæ•°æ®
const sql = `
  SELECT id, box, path, hpath, content AS name, updated
  FROM blocks
  WHERE type = 'd'
  ORDER BY updated DESC
`;

const response = await fetch("/api/query/sql", {
  method: "POST",
  body: JSON.stringify({ stmt: sql })
});

// è¿”å›: DocMetadata[]
// çº¦ 2000 æ¡è®°å½•ï¼Œ50KB æ•°æ®ï¼Œè€—æ—¶ 50-100ms
```

**å…³é”®ä¼˜åŠ¿**:
1. **é¿å…å¯¼å‡º**: ä¸è°ƒç”¨ `exportMdContent`ï¼ˆæ¯æ¬¡ 50-100msï¼‰
2. **æ‰¹é‡è·å–**: ä¸€æ¬¡è¯·æ±‚ vs 2000 æ¬¡è¯·æ±‚
3. **è½»é‡çº§**: ä»…å…ƒæ•°æ®ï¼Œä¸å«æ–‡æ¡£å†…å®¹

**é˜¶æ®µ 2: æ—¶é—´æˆ³æ¯”è¾ƒè¿‡æ»¤**

```typescript
// æ–‡ä»¶: incremental-sync.ts - getChangedDocuments()

async function getChangedDocuments(
  plugin: Plugin,
  allDocs: DocMetadata[]
): Promise<DocMetadata[]> {
  const changed: DocMetadata[] = [];

  for (const doc of allDocs) {
    // ä»ç¼“å­˜è¯»å–ä¸Šæ¬¡åŒæ­¥çš„æ—¶é—´æˆ³
    const cached = await getDocCacheEntry(plugin, doc.box, doc.id);

    if (!cached) {
      // æ–°æ–‡æ¡£ï¼Œæœªç¼“å­˜
      changed.push(doc);
      continue;
    }

    if (doc.updated > cached.siyuanUpdated) {
      // æ–‡æ¡£å·²ä¿®æ”¹ (SiYuan æ—¶é—´æˆ³æ›´æ–°)
      changed.push(doc);
      continue;
    }

    // else: æ–‡æ¡£æœªå˜åŒ–ï¼Œè·³è¿‡
  }

  return changed;
}
```

**æ€§èƒ½åˆ†æ**:
- ç¼“å­˜æŸ¥è¯¢: O(1) å¹³å‡ï¼ˆJSON å¯¹è±¡æŸ¥æ‰¾ï¼‰
- æ€»æ—¶é—´å¤æ‚åº¦: O(n)ï¼Œn = æ–‡æ¡£æ€»æ•°
- å®é™…è€—æ—¶: 2000 æ–‡æ¡£çº¦ 20-50ms

**é˜¶æ®µ 3: ä»…å¯¼å‡ºå˜åŒ–çš„æ–‡æ¡£**

```typescript
// ä»…å¤„ç† 1% çš„æ–‡æ¡£ï¼ˆ20/2000ï¼‰
for (const doc of changedDocs) {
  const content = await exportMdContent(doc.id);
  const hash = await calculateHash(content);

  // ä¸ GitHub SHA æ¯”è¾ƒ
  const needsUpload = await checkNeedsUpload(hash, cachedSHA);

  if (needsUpload) {
    await uploadToGitHub(doc.path, content, hash);
  }
}
```

**æ€§èƒ½æå‡**:
- æ— ç¼“å­˜: 2000 Ã— 100ms = 200s
- v0.2.0 ç¼“å­˜: 2000 Ã— 50ms = 100s (å“ˆå¸Œæ¯”è¾ƒ)
- v0.3.0 å¢é‡: 20 Ã— 100ms = 2s (ä»…å˜åŒ–çš„)
- **æå‡å€æ•°**: 100x

#### èµ„æºæ‰«ææµç¨‹

**é˜¶æ®µ 1: ç›®å½•æ‰«æï¼ˆä»…å…ƒæ•°æ®-modificationTimeï¼‰**

```typescript
// æ–‡ä»¶: incremental-sync.ts - getAllAssetMetadata()

async function getAllAssetMetadata(): Promise<AssetMetadata[]> {
  const assetsDir = "/data/assets";
  const files = await listDirectory(assetsDir);

  return files.map(file => ({
    name: file.name,
    path: file.path,
    size: file.size,
    mtime: file.modificationTime  // ä»…è¯»å– mtimeï¼Œä¸è¯»æ–‡ä»¶å†…å®¹
  }));
}
```

**å…³é”®ä¼˜åŠ¿**:
- ä¸è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆ5000 Ã— 1MB = 5GBï¼‰
- ä»…è¯»å–æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ï¼ˆmtime, sizeï¼‰
- è€—æ—¶: 5000 æ–‡ä»¶çº¦ 100-200ms

**é˜¶æ®µ 2: æ—¶é—´æˆ³è¿‡æ»¤**

```typescript
// æ–‡ä»¶: incremental-sync.ts - getChangedAssets()

async function getChangedAssets(
  plugin: Plugin,
  allAssets: AssetMetadata[]
): Promise<AssetMetadata[]> {
  const lastSyncTime = await getLastAssetSyncTime(plugin);

  return allAssets.filter(asset => {
    // æ–°èµ„æºæˆ–å·²ä¿®æ”¹
    return asset.mtime > lastSyncTime;
  });
}
```

**æ€§èƒ½åˆ†æ**:
- æ¯”è¾ƒæ“ä½œ: O(n)ï¼Œn = èµ„æºæ€»æ•°
- å®é™…è€—æ—¶: 5000 èµ„æºçº¦ 10-20ms
- å…¸å‹ç»“æœ: 5000 èµ„æºä¸­ä»… 5 ä¸ªå˜åŒ–ï¼ˆ0.1%ï¼‰

**é˜¶æ®µ 3: æ‰¹é‡ä¸Šä¼ **

```typescript
const CONCURRENCY = 5;

for (let i = 0; i < changedAssets.length; i += CONCURRENCY) {
  const batch = changedAssets.slice(i, i + CONCURRENCY);

  await Promise.allSettled(
    batch.map(asset => uploadAssetToGitHub(asset))
  );
}
```

**æ€§èƒ½æå‡**:
- æ— ç¼“å­˜: 5000 Ã— 200ms = 1000s
- v0.2.0 ç¼“å­˜: 5000 Ã— 100ms = 500s (å“ˆå¸Œæ¯”è¾ƒ)
- v0.3.0 å¢é‡: 5 Ã— 200ms = 1s (ä»…å˜åŒ–çš„)
- **æå‡å€æ•°**: 1000x

---

### è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨

#### è®¾è®¡ç›®æ ‡

æä¾›å¯é çš„åå°å®šæ—¶åŒæ­¥ï¼Œç‰¹ç‚¹ï¼š
- å¯é…ç½®çš„åŒæ­¥é—´éš”ï¼ˆ1-1440 åˆ†é’Ÿï¼‰
- é˜²æ­¢é‡å¤è¿è¡Œï¼ˆåŒä¸€æ—¶é—´ä»…ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼‰
- å¯åŠ¨æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
- ä¼˜é›…çš„å¯åŠ¨/åœæ­¢/é‡å¯

#### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨æ¶æ„ (v0.3.0)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Plugin onload()   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Check Settings    â”‚
                  â”‚  autoSync.enabled? â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ YES           â”‚ No
                    â”‚               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â–¼ 
          â”‚  AutoSyncSchedulerâ”‚    Skip
          â”‚  .start()         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  Run Sync â”‚  â”‚  Set    â”‚  â”‚  State   â”‚
â”‚ Immediate â”‚  â”‚ Timer   â”‚  â”‚ isRunningâ”‚
â”‚ (once)    â”‚  â”‚setInter â”‚  â”‚= false   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚val()    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚             â”‚
      â”‚        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚        â”‚  Timer Tick         â”‚
      â”‚        â”‚  (every N minutes)  â”‚
      â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚
      â”‚        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚        â”‚ isRunning?  â”‚
      â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚
      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚    â–¼ YES           â”‚ NO
      â”‚   Skip             â”‚
      â”‚                    â”‚
      â””â”€â”€â”€â”€â”€--â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  performIncrementalâ”‚
          â”‚  Sync()            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚  Scan  â”‚  â”‚ Upload â”‚  â”‚ Update â”‚
   â”‚Changed â”‚  â”‚  Batch â”‚  â”‚ Cache  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚          â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Log Result      â”‚
          â”‚  Update Status   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒå®ç°

**æ–‡ä»¶**: `auto-sync-scheduler.ts`

```typescript
export class AutoSyncScheduler {
  private timerId: number | null = null;
  private isRunning = false;
  private plugin: Plugin;
  private settings: Settings;

  async start(): Promise<void> {
    if (this.timerId !== null) {
      console.warn("[AutoSync] Already started");
      return;
    }

    const intervalMs = this.settings.autoSync.interval * 60 * 1000;

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    void this.runSync();

    // è®¾ç½®å®šæ—¶å™¨
    this.timerId = window.setInterval(() => {
      void this.runSync();
    }, intervalMs);

    console.log(`[AutoSync] Scheduler started (interval: ${this.settings.autoSync.interval}min)`);
  }

  async stop(): Promise<void> {
    if (this.timerId !== null) {
      window.clearInterval(this.timerId);
      this.timerId = null;
      console.log("[AutoSync] Scheduler stopped");
    }
  }

  async restart(): Promise<void> {
    await this.stop();
    await this.start();
  }

  private async runSync(): Promise<void> {
    // é˜²æ­¢é‡å¤è¿è¡Œ
    if (this.isRunning) {
      console.warn("[AutoSync] Already running, skipping this tick");
      return;
    }

    this.isRunning = true;

    try {
      const startTime = Date.now();

      // è°ƒç”¨å¢é‡åŒæ­¥å¼•æ“
      const result = await performIncrementalSync(
        this.plugin,
        this.settings,
        this.onProgress
      );

      const duration = Date.now() - startTime;

      // è®°å½•ç»“æœ
      await this.logSyncResult(result, duration);

    } catch (error) {
      console.error("[AutoSync] Sync failed:", error);
      this.plugin.showMessage(`Auto sync failed: ${error.message}`, 5000);
    } finally {
      this.isRunning = false;
    }
  }

  private async logSyncResult(
    result: IncrementalSyncResult,
    duration: number
  ): Promise<void> {
    console.log(`[AutoSync] Sync complete:
  Documents: ${result.docs.uploaded} uploaded, ${result.docs.skipped} skipped, ${result.docs.failed} failed
  (${result.docs.scanned} scanned, ${result.docs.changed} changed)
  Assets: ${result.assets.uploaded} uploaded, ${result.assets.skipped} skipped, ${result.assets.failed} failed
  (${result.assets.scanned} scanned, ${result.assets.changed} changed)
  Time: ${(duration / 1000).toFixed(1)}s`);

    // æ›´æ–°çŠ¶æ€æ 
    if (result.docs.failed === 0 && result.assets.failed === 0) {
      this.plugin.showMessage(
        `âœ… Auto sync: ${result.docs.uploaded + result.assets.uploaded} files synced`,
        3000
      );
    } else {
      this.plugin.showMessage(
        `âš ï¸ Auto sync: ${result.docs.failed + result.assets.failed} files failed`,
        5000
      );
    }
  }
}
```

#### ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ’ä»¶å¯åŠ¨** (`index.ts - onload()`):
```typescript
async onload() {
  await this.loadSettings();

  // åˆå§‹åŒ–è°ƒåº¦å™¨
  this.autoSyncScheduler = new AutoSyncScheduler(this, this.settings);

  // å¦‚æœå¯ç”¨ï¼Œè‡ªåŠ¨å¯åŠ¨
  if (this.settings.autoSync.enabled) {
    await this.autoSyncScheduler.start();
  }
}
```

**æ’ä»¶å¸è½½** (`index.ts - onunload()`):
```typescript
async onunload() {
  // åœæ­¢è°ƒåº¦å™¨
  if (this.autoSyncScheduler) {
    await this.autoSyncScheduler.stop();
  }
}
```

**è®¾ç½®æ›´æ”¹** (`index.ts - doSave()`):
```typescript
private async doSave(): Promise<void> {
  await this.saveSettings();

  // é‡å¯è°ƒåº¦å™¨ä»¥åº”ç”¨æ–°è®¾ç½®
  if (this.autoSyncScheduler) {
    await this.autoSyncScheduler.restart();
  }
}
```

#### å¹¶å‘æ§åˆ¶

**é˜²æ­¢é‡å¤è¿è¡Œ**:
```typescript
private isRunning = false;

private async runSync(): Promise<void> {
  if (this.isRunning) {
    console.warn("[AutoSync] Already running, skipping");
    return;  // è·³è¿‡æœ¬æ¬¡
  }

  this.isRunning = true;
  try {
    await performIncrementalSync(...);
  } finally {
    this.isRunning = false;  // ç¡®ä¿é‡Šæ”¾é”
  }
}
```

**åœºæ™¯åˆ†æ**:
- åŒæ­¥é—´éš”: 10 åˆ†é’Ÿ
- åŒæ­¥è€—æ—¶: 15 åˆ†é’Ÿï¼ˆç½‘ç»œæ…¢ï¼‰

```
æ—¶é—´è½´:
0:00  - Timer tick â†’ runSync() å¼€å§‹
0:15  - runSync() å®Œæˆ
0:10  - Timer tick â†’ æ£€æµ‹åˆ° isRunning=true â†’ è·³è¿‡
0:20  - Timer tick â†’ runSync() å¼€å§‹
...
```

---

### æ€§èƒ½ä¼˜åŒ–åˆ†æ

#### æ•´ä½“æ€§èƒ½å¯¹æ¯”

**æµ‹è¯•ç¯å¢ƒ**:
- ç¬”è®°æ•°: 2000 ç¯‡
- èµ„æºæ•°: 5000 ä¸ª
- æ¯æ—¥å˜åŒ–ç‡: 1% (20 ç¯‡æ–‡æ¡£ + 5 ä¸ªèµ„æº)

**åœºæ™¯ 1: é¦–æ¬¡å…¨é‡åŒæ­¥**

| ç‰ˆæœ¬ | æ–‡æ¡£å¯¼å‡º | å“ˆå¸Œè®¡ç®— | GitHubè¯·æ±‚ | æ€»è€—æ—¶ |
|------|---------|---------|-----------|--------|
| v0.1.0 | 200s | 40s | 2000Ã—100ms=200s | ~440s |
| v0.2.0 | 200s | 40s | è·³è¿‡50% | ~340s |
| v0.3.0 | 200s | 40s | è·³è¿‡50% | ~340s |

**ç»“è®º**: é¦–æ¬¡åŒæ­¥æ— æ€§èƒ½å·®å¼‚ï¼ˆå¿…é¡»å…¨é‡å¤„ç†ï¼‰

**åœºæ™¯ 2: æ¯æ—¥åŒæ­¥ï¼ˆ1% å˜åŒ–ï¼‰**

| ç‰ˆæœ¬ | æ‰«æ | å¯¼å‡º | å“ˆå¸Œ | ä¸Šä¼  | æ€»è€—æ—¶ |
|------|-----|-----|-----|-----|--------|
| v0.1.0 | - | 200s | 40s | 20s | ~260s |
| v0.2.0 | - | 200s | 40s | 2s (ç¼“å­˜å‘½ä¸­) | ~242s |
| v0.3.0 | 0.1s (SQL) | 2s (ä»…20ç¯‡) | 0.4s | 2s | **4.5s** |

**æå‡**: v0.2.0 â†’ v0.3.0 = **54x åŠ é€Ÿ**

**åœºæ™¯ 3: æ— å˜åŒ–ï¼ˆä»…æ‰«æï¼‰**

| ç‰ˆæœ¬ | æ‰«æ | å…¶ä»–æ“ä½œ | æ€»è€—æ—¶ |
|------|-----|---------|--------|
| v0.1.0 | - | å…¨é‡å¤„ç† | ~260s |
| v0.2.0 | - | å…¨é‡å“ˆå¸Œæ¯”è¾ƒ | ~240s |
| v0.3.0 | 0.1s | æ—  | **0.1s** |

**æå‡**: v0.2.0 â†’ v0.3.0 = **2400x åŠ é€Ÿ**

#### èµ„æºæ¶ˆè€—å¯¹æ¯”

**CPU å ç”¨** (10åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥é—´éš”):

```
v0.1.0 (æ— ç¼“å­˜):
  æ¯10åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ¯æ¬¡260s
  CPUå ç”¨: 260s / 600s = 43%

v0.2.0 (ç¼“å­˜):
  æ¯10åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ¯æ¬¡240s
  CPUå ç”¨: 240s / 600s = 40%

v0.3.0 (å¢é‡):
  æ¯10åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ¯æ¬¡4.5s
  CPUå ç”¨: 4.5s / 600s = 0.75%
```

**æå‡**: **53x é™ä½ CPU å ç”¨**

**ç½‘ç»œæµé‡** (æ¯æ—¥åŒæ­¥):

```
v0.1.0:
  2000 GET (æ£€æŸ¥SHA) + 2000 PUT = 4000 è¯·æ±‚
  ä¼ è¾“: 200MB (markdown) + 5GB (assets)

v0.2.0:
  2000 GET + 20 PUT = 2020 è¯·æ±‚ (99%ç¼“å­˜å‘½ä¸­)
  ä¼ è¾“: 2MB (ä»…å˜åŒ–çš„)

v0.3.0:
  20 GET + 20 PUT = 40 è¯·æ±‚ (ä»…æ‰«æå˜åŒ–çš„)
  ä¼ è¾“: 2MB (ä»…å˜åŒ–çš„)
```

**æå‡**: **50x å‡å°‘ç½‘ç»œè¯·æ±‚**

#### å†…å­˜å ç”¨

```
v0.1.0:
  ç¼“å­˜: 0MB
  è¿è¡Œæ—¶: ~100MB (å¯¼å‡º2000ç¯‡æ–‡æ¡£)

v0.2.0:
  ç¼“å­˜: ~10MB (2000æ–‡æ¡£ + 5000èµ„æº)
  è¿è¡Œæ—¶: ~100MB

v0.3.0:
  ç¼“å­˜: ~10MB
  è¿è¡Œæ—¶: ~20MB (ä»…å¤„ç†20ç¯‡æ–‡æ¡£)
```

**æå‡**: **5x é™ä½è¿è¡Œæ—¶å†…å­˜**

#### æœ€ä½³å®è·µæ¨è

**1. è‡ªåŠ¨åŒæ­¥é—´éš”é…ç½®**

| ä»“åº“è§„æ¨¡ | æ¨èé—´éš” | ç†ç”± |
|---------|---------|------|
| < 500æ–‡æ¡£ | 5-10åˆ†é’Ÿ | æ€§èƒ½å½±å“å¯å¿½ç•¥ |
| 500-2000æ–‡æ¡£ | 10-30åˆ†é’Ÿ | å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½ |
| 2000+æ–‡æ¡£ | 30-60åˆ†é’Ÿ | é¿å…é¢‘ç¹æ‰«æ |

**2. GitHub API é™æµè€ƒè™‘**

GitHub API é™åˆ¶:
- è®¤è¯ç”¨æˆ·: 5000 è¯·æ±‚/å°æ—¶
- æ¯æ¬¡åŒæ­¥æœ€å¤š: 40 è¯·æ±‚ (v0.3.0 å¢é‡)
- å¯æ”¯æŒ: 5000 / 40 = 125 æ¬¡åŒæ­¥/å°æ—¶
- å®‰å…¨é—´éš”: â‰¥ 60/125 = 0.48 åˆ†é’Ÿ

**ç»“è®º**: 5 åˆ†é’Ÿé—´éš”å®Œå…¨å®‰å…¨

**3. æ€§èƒ½ç›‘æ§æŒ‡æ ‡**

å…³é”®æŒ‡æ ‡åŠæ­£å¸¸å€¼:
```
æ‰«ææ—¶é—´: < 1s (2000æ–‡æ¡£)
ç¼“å­˜å‘½ä¸­ç‡: > 98%
ä¸Šä¼ æ—¶é—´: ~0.5s/æ–‡æ¡£
å¤±è´¥ç‡: < 1%
```

å¦‚æœè¶…å‡ºæ­£å¸¸å€¼:
- æ‰«ææ—¶é—´è¿‡é•¿ â†’ æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
- ç¼“å­˜å‘½ä¸­ç‡ä½ â†’ æ£€æŸ¥æ–‡æ¡£é¢‘ç¹ä¿®æ”¹åŸå› 
- ä¸Šä¼ æ—¶é—´è¿‡é•¿ â†’ æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
- å¤±è´¥ç‡é«˜ â†’ æ£€æŸ¥ GitHub API çŠ¶æ€

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### ä¸‰æ–¹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LifeOS Sync ç³»ç»Ÿæ¶æ„                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Client A (æ¡Œé¢ç‰ˆ)              Client B (Docker)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SiYuan App  â”‚              â”‚  SiYuan Web  â”‚
    â”‚  (localhost) â”‚              â”‚   (HTTP)     â”‚
    â”‚              â”‚              â”‚              â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ Plugin   â”‚ â”‚              â”‚ â”‚ Plugin   â”‚ â”‚
    â”‚ â”‚ Sync     â”‚ â”‚              â”‚ â”‚ Sync     â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚      â”‚       â”‚              â”‚      â”‚       â”‚
    â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚              â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ Local    â”‚ â”‚              â”‚ â”‚ Local    â”‚ â”‚
    â”‚ â”‚ Cache    â”‚ â”‚              â”‚ â”‚ Cache    â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
           â””â”€â”€â”€â”€â”€â–º   GitHub      â—„â”€â”€â”€â”€â”€â”€â”˜
                 â”‚  (Remote)     â”‚
                 â”‚               â”‚
                 â”‚ main branch   â”‚
                 â”‚ - docs/       â”‚
                 â”‚ - assets/     â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **Hash Utils** (`hash-utils.ts`)
   - æä¾›å¤šç¯å¢ƒå…¼å®¹çš„å“ˆå¸Œç®—æ³•
   - SHA-256 (ä¼˜å…ˆ) æˆ– FNV-1a (é™çº§)

2. **Cache Manager** (`cache-manager.ts`)
   - ç®¡ç†æ–‡æ¡£å’Œèµ„æºçš„ç¼“å­˜
   - åˆ†ç‰‡å­˜å‚¨ï¼Œé«˜æ•ˆè¯»å†™

3. **Incremental Sync** (`incremental-sync.ts`) **[v0.3.0]**
   - SQL å…ƒæ•°æ®æŸ¥è¯¢
   - æ—¶é—´æˆ³å˜åŒ–æ£€æµ‹
   - å¢é‡æ–‡æ¡£/èµ„æºæ‰«æ

4. **Auto Sync Scheduler** (`auto-sync-scheduler.ts`) **[v0.3.0]**
   - å®šæ—¶è§¦å‘åŒæ­¥
   - å¹¶å‘æ§åˆ¶
   - ç”Ÿå‘½å‘¨æœŸç®¡ç†

5. **Exporter** (`exporter.ts`)
   - æ–‡æ¡£å¯¼å‡ºä¸»é€»è¾‘
   - é›†æˆç¼“å­˜æ£€æµ‹

6. **Assets Sync** (`assets-sync.ts`)
   - æ‰¹é‡èµ„æºåŒæ­¥
   - å¹¶å‘æ§åˆ¶

---

## å“ˆå¸Œç®—æ³•è¯¦è§£

### ç®—æ³•é€‰æ‹©ç­–ç•¥

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å“ˆå¸Œç®—æ³•é€‰æ‹©å†³ç­–æ ‘                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

crypto.subtle å¯ç”¨ï¼Ÿ
    â”‚
    â”œâ”€ YES â”€â”€â–º å°è¯•ä½¿ç”¨ SHA-256
    â”‚             â”‚
    â”‚             â”œâ”€ æˆåŠŸ â”€â”€â–º è¿”å› SHA-256 å“ˆå¸Œ
    â”‚             â”‚
    â”‚             â””â”€ å¤±è´¥ â”€â”€â–º FNV-1a å“ˆå¸Œ (é™çº§)
    â”‚
    â””â”€ NO  â”€â”€â–º FNV-1a å“ˆå¸Œ (é™çº§)
```

### SHA-256 å®ç°

```typescript
// æ–‡ä»¶: hash-utils.ts
async function calculateHash(text: string): Promise<string> {
  if (typeof crypto !== "undefined" && crypto.subtle) {
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    } catch (e) {
      console.warn("[Hash] crypto.subtle failed, using fallback:", e);
    }
  }
  return simpleHash(text); // é™çº§
}
```

**ç‰¹ç‚¹:**
- è¾“å‡º: 64 å­—ç¬¦åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- ä¾‹å¦‚: `a3c8f9e2d1b4c7a9...` (64 chars)
- å®‰å…¨æ€§: åŠ å¯†çº§åˆ«
- æ€§èƒ½: æµè§ˆå™¨åŸç”Ÿä¼˜åŒ–

### FNV-1a å®ç°

```typescript
// æ–‡ä»¶: hash-utils.ts
function simpleHash(str: string): string {
  let hash = 2166136261; // FNV offset basis (32-bit)
  for (let i = 0; i < str.length; i++) {
    hash ^= str.charCodeAt(i);        // XOR with byte
    hash += (hash << 1) + (hash << 4) +
            (hash << 7) + (hash << 8) +
            (hash << 24);                // Multiply by FNV prime
  }
  return (hash >>> 0).toString(16).padStart(8, "0");
}
```

**ç‰¹ç‚¹:**
- è¾“å‡º: 8 å­—ç¬¦åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- ä¾‹å¦‚: `a3c8f9e2` (8 chars)
- å®‰å…¨æ€§: éåŠ å¯†çº§åˆ«ï¼ˆè¶³å¤Ÿç¼“å­˜å»é‡ï¼‰
- æ€§èƒ½: æå¿«ï¼ˆçº¯æ•´æ•°è¿ç®—ï¼‰

### ç¯å¢ƒå…¼å®¹æ€§çŸ©é˜µ

| ç¯å¢ƒ | crypto.subtle | ä½¿ç”¨ç®—æ³• | å“ˆå¸Œé•¿åº¦ |
|------|--------------|---------|---------|
| Windows æ¡Œé¢ç‰ˆ | âœ… å¯ç”¨ | SHA-256 | 64 chars |
| macOS æ¡Œé¢ç‰ˆ | âœ… å¯ç”¨ | SHA-256 | 64 chars |
| Docker + HTTPS | âœ… å¯ç”¨ | SHA-256 | 64 chars |
| Docker + HTTP | âŒ ä¸å¯ç”¨ | FNV-1a | 8 chars |
| localhostå¼€å‘ | âœ… å¯ç”¨ | SHA-256 | 64 chars |

### å“ˆå¸Œç¢°æ’åˆ†æ

**SHA-256:**
- ç¢°æ’æ¦‚ç‡: 2^-256 â‰ˆ 0ï¼ˆå®é™…ä¸å¯èƒ½ï¼‰
- é€‚ç”¨åœºæ™¯: å®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯

**FNV-1a (32-bit):**
- ç¢°æ’æ¦‚ç‡: 2^-32 â‰ˆ 1/4,294,967,296
- å¯¹äº 10000 ä¸ªæ–‡æ¡£: ç¢°æ’æ¦‚ç‡ â‰ˆ 0.001%
- é€‚ç”¨åœºæ™¯: ç¼“å­˜å»é‡ï¼ˆå¯æ¥å—æä½ç¢°æ’é£é™©ï¼‰

---

## ç¼“å­˜ç³»ç»Ÿæ¶æ„

### ç¼“å­˜æ–‡ä»¶ç»“æ„

```
data/storage/petal/lifeos_sync/
â”‚
â”œâ”€â”€ sync-meta.json                         # å…¨å±€å…ƒæ•°æ®
â”‚   â”œâ”€â”€ lastFullSync: number               # æœ€åä¸€æ¬¡å…¨é‡åŒæ­¥æ—¶é—´æˆ³
â”‚   â””â”€â”€ notebooks: {                       # ç¬”è®°æœ¬ç´¢å¼•
â”‚       "20241221133023-nntepeb": {
â”‚           notebookId: string             # ç¬”è®°æœ¬ID
â”‚           notebookName: string           # ç¬”è®°æœ¬åç§°
â”‚           docCount: number               # æ–‡æ¡£æ•°é‡
â”‚           lastSyncTime: number           # æœ€ååŒæ­¥æ—¶é—´
â”‚       }
â”‚   }
â”‚
â”œâ”€â”€ cache-{notebookId}.json                # ç¬”è®°æœ¬çš„æ–‡æ¡£ç¼“å­˜ [v0.3.0æ›´æ–°]
â”‚   â””â”€â”€ {
â”‚       "20241221133029-8eietj4": {        # æ–‡æ¡£ID
â”‚           docId: string                  # æ–‡æ¡£ID
â”‚           notebookId: string             # æ‰€å±ç¬”è®°æœ¬
â”‚           githubPath: string             # GitHubè·¯å¾„
â”‚           contentHash: string            # å†…å®¹å“ˆå¸Œ (SHA-256/FNV-1a)
â”‚           githubSHA: string              # GitHub blob SHA
â”‚           lastSyncTime: number           # æœ€ååŒæ­¥æ—¶é—´æˆ³
â”‚           siyuanUpdated: number          # SiYuanæ›´æ–°æ—¶é—´ [æ–°å¢]
â”‚       }
â”‚   }
â”‚
â”œâ”€â”€ assets-cache-{0-f}.json                # èµ„æºç¼“å­˜åˆ†ç‰‡ [v0.3.0æ›´æ–°]
â”‚   â””â”€â”€ {
â”‚       "20210808180117-abc123.png": {
â”‚           assetPath: string              # èµ„æºè·¯å¾„
â”‚           contentHash: string            # æ–‡ä»¶å“ˆå¸Œ
â”‚           githubSHA: string              # GitHub SHA
â”‚           lastSyncTime: number           # åŒæ­¥æ—¶é—´
â”‚           fileSize: number               # æ–‡ä»¶å¤§å°
â”‚           mtime: number                  # æ–‡ä»¶ä¿®æ”¹æ—¶é—´ [æ–°å¢]
â”‚       }
â”‚   }
â”‚
â””â”€â”€ last-asset-sync-time                   # èµ„æºä¸Šæ¬¡åŒæ­¥æ—¶é—´æˆ³ [v0.3.0æ–°å¢]
```

### ç¼“å­˜åˆ†ç‰‡ç®—æ³•

```typescript
// æ–‡ä»¶: cache-manager.ts

// èµ„æºè·¯å¾„ â†’ åˆ†ç‰‡å· (0-15)
async function getAssetShard(assetPath: string): Promise<number> {
  const hash = await calculateShardHash(assetPath);
  // å–å“ˆå¸Œçš„å‰2ä¸ªå­—ç¬¦ï¼Œè½¬ä¸ºæ•´æ•°ï¼Œæ¨¡16
  return parseInt(hash.substring(0, 2), 16) % 16;
}

// ç¤ºä¾‹:
// assetPath: "20210808180117-abc123.png"
// hash:      "a3c8f9e2..."
// å‰2å­—ç¬¦:    "a3"
// è½¬æ•´æ•°:     163 (0xa3)
// æ¨¡16:       3
// ç»“æœ:       å­˜å‚¨åœ¨ assets-cache-3.json
```

**åˆ†ç‰‡åˆ†å¸ƒç¤ºä¾‹** (10000ä¸ªèµ„æº):

```
assets-cache-0.json:  625 ä¸ªèµ„æº  (~150KB)
assets-cache-1.json:  625 ä¸ªèµ„æº  (~150KB)
assets-cache-2.json:  625 ä¸ªèµ„æº  (~150KB)
...
assets-cache-f.json:  625 ä¸ªèµ„æº  (~150KB)

æ€»è®¡: 10000 ä¸ªèµ„æº, å‡åŒ€åˆ†å¸ƒ
```

### ç¼“å­˜è¯»å†™æµç¨‹

#### è¯»å–æ–‡æ¡£ç¼“å­˜

```typescript
// 1. æ„å»ºç¼“å­˜æ–‡ä»¶å
cacheFile = `cache-${notebookId}.json`

// 2. ä»SiYuanå­˜å‚¨åŠ è½½
cache = await plugin.loadData(cacheFile)

// 3. æŸ¥æ‰¾æ–‡æ¡£æ¡ç›®
entry = cache[docId]

// 4. æ¯”è¾ƒæ—¶é—´æˆ³ [v0.3.0]
if (entry && doc.updated <= entry.siyuanUpdated) {
    // æ–‡æ¡£æœªå˜åŒ–ï¼Œè·³è¿‡
    return CACHE_HIT
} else {
    // æ–‡æ¡£å˜åŒ–æˆ–æ–°æ–‡æ¡£ï¼Œéœ€è¦å¤„ç†
    return CACHE_MISS
}
```

#### å†™å…¥æ–‡æ¡£ç¼“å­˜

```typescript
// 1. åŠ è½½ç°æœ‰ç¼“å­˜
cache = await loadNotebookDocCache(plugin, notebookId)

// 2. æ›´æ–°æ¡ç›®
cache[docId] = {
    docId,
    notebookId,
    githubPath: "test1/hello world-3.md",
    contentHash: "a3c8f9e2d1b4c7a9e5f6a2b8c1d9e0f3...",
    githubSHA: "9f8e7d6c5b4a3921e0d8c7b6a5948372",
    lastSyncTime: 1736985600000,
    siyuanUpdated: 1736985500000    // è®°å½•SiYuanæ—¶é—´æˆ³
}

// 3. ä¿å­˜ç¼“å­˜
await plugin.saveData(cacheFile, cache)
```

### ç¼“å­˜æ€§èƒ½åˆ†æ

#### å•ä¸€æ–‡ä»¶ vs åˆ†ç‰‡ç¼“å­˜

**åœºæ™¯: æ›´æ–°1ä¸ªæ–‡æ¡£**

| æ–¹æ¡ˆ | è¯»å– | ä¿®æ”¹ | å†™å…¥ | æ€»è€—æ—¶ |
|-----|-----|-----|-----|-------|
| å•ä¸€æ–‡ä»¶ (10000æ–‡æ¡£) | è¯»å–5MB | å†…å­˜æ“ä½œ | å†™å…¥5MB | ~100ms |
| åˆ†ç‰‡ç¼“å­˜ (100æ–‡æ¡£/ç¬”è®°æœ¬) | è¯»å–100KB | å†…å­˜æ“ä½œ | å†™å…¥100KB | ~2ms |
| **æ€§èƒ½æå‡** | | | | **50å€** |

**åœºæ™¯: å¹¶å‘æ›´æ–°10ä¸ªæ–‡æ¡£**

| æ–¹æ¡ˆ | å¹¶å‘èƒ½åŠ› | æ€»è€—æ—¶ |
|-----|---------|-------|
| å•ä¸€æ–‡ä»¶ | âŒ ä¸²è¡Œï¼ˆå†™å†²çªï¼‰ | 10 Ã— 100ms = 1000ms |
| åˆ†ç‰‡ç¼“å­˜ (ä¸åŒç¬”è®°æœ¬) | âœ… å¹¶è¡Œ | max(2ms) = 2ms |
| **æ€§èƒ½æå‡** | | **500å€** |

---

## åŒæ­¥æµç¨‹è¯¦è§£

### å¢é‡åŒæ­¥æµç¨‹ (v0.3.0 æ–°å¢)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¢é‡åŒæ­¥å®Œæ•´æµç¨‹ (Auto/Manual)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘å™¨: Auto Sync Timer / Manual Button Click
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–æ‰€æœ‰æ–‡æ¡£å…ƒæ•°æ®  â”‚
â”‚    SQL Query:         â”‚
â”‚    SELECT id, box,    â”‚
â”‚    updated FROM blocksâ”‚
â”‚    WHERE type='d'     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ—¶é—´æˆ³æ¯”è¾ƒè¿‡æ»¤     â”‚
â”‚    for each doc:      â”‚
â”‚      if doc.updated > â”‚
â”‚      cached.updated   â”‚
â”‚        â†’ å˜åŒ–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   æ‰¾åˆ° 20/2000 å˜åŒ–çš„æ–‡æ¡£
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä»…å¯¼å‡ºå˜åŒ–çš„æ–‡æ¡£   â”‚
â”‚    for changed docs:  â”‚
â”‚      exportMd()       â”‚
â”‚      calculateHash()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å“ˆå¸Œæ¯”è¾ƒ           â”‚
â”‚    if hash â‰  cached   â”‚
â”‚      â†’ ä¸Šä¼            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ‰¹é‡ä¸Šä¼  (5å¹¶å‘)   â”‚
â”‚    Promise.allSettled â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ›´æ–°ç¼“å­˜           â”‚
â”‚    siyuanUpdated =    â”‚
â”‚    doc.updated        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
      [å®Œæˆ: 11s]
```

### æ–‡æ¡£åŒæ­¥æµç¨‹ (Export Current Doc)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ–‡æ¡£åŒæ­¥æµç¨‹ (å¸¦ç¼“å­˜æ£€æµ‹)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç‚¹å‡» "Export current doc"
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–æ–‡æ¡£ä¿¡æ¯    â”‚
â”‚  - docId          â”‚
â”‚  - notebookId     â”‚
â”‚  - hpath          â”‚
â”‚  - title          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å¯¼å‡ºMarkdown    â”‚
â”‚  - è°ƒç”¨SiYuan API â”‚
â”‚  - æ¸…ç†frontmatterâ”‚
â”‚  - é‡å†™èµ„æºé“¾æ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è®¡ç®—å†…å®¹å“ˆå¸Œ    â”‚
â”‚  - calculateHash()â”‚
â”‚  - ç»“æœ: hashå€¼   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ£€æŸ¥æœ¬åœ°ç¼“å­˜            â”‚
â”‚  - getDocCacheEntry()     â”‚
â”‚  - æŸ¥æ‰¾: cache-xxx.json   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    ç¼“å­˜å­˜åœ¨ï¼Ÿ
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
   YES       NO
    â”‚         â”‚
    â–¼         â–¼
å“ˆå¸Œç›¸åŒï¼Ÿ   [ç»§ç»­]
    â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”
â”‚       â”‚
YES    NO
â”‚       â”‚
â–¼       â–¼
[è·³è¿‡]  [ç»§ç»­]

ç»§ç»­ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä¸Šä¼ åˆ°GitHub    â”‚
â”‚  - createOrUpdate â”‚
â”‚  - è·å–GitHub SHA â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ›´æ–°æœ¬åœ°ç¼“å­˜    â”‚
â”‚  - updateDocCache â”‚
â”‚  - ä¿å­˜å“ˆå¸Œ+SHA   â”‚
â”‚  - ä¿å­˜updated    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
      [å®Œæˆ]
```

---

## åˆ†å¸ƒå¼åŒæ­¥æœºåˆ¶

### åœºæ™¯æè¿°

**ç”¨æˆ·æœ‰2ä¸ªå®¢æˆ·ç«¯:**
- **Client A**: Windows æ¡Œé¢ç‰ˆ (localhost)
- **Client B**: Docker éƒ¨ç½² (HTTP)

**åŒæ­¥ç›®æ ‡:**
- æ‰€æœ‰å®¢æˆ·ç«¯çš„ç¬”è®°æœ€ç»ˆåŒæ­¥åˆ° GitHub
- é€šè¿‡ GitHub ä½œä¸ºä¸­å¿ƒèŠ‚ç‚¹è¿›è¡ŒåŒæ­¥

### åˆ†å¸ƒå¼æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å¸ƒå¼åŒæ­¥æ¶æ„å›¾                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Client A                     GitHub                   Client B
    (Windows)                   (Remote)                  (Docker)

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Doc A1 â”‚â”€â”               â”‚ Doc A1 â”‚               â”‚ Doc B1 â”‚
    â”‚ Hash:  â”‚ â”‚               â”‚ SHA:   â”‚               â”‚ Hash:  â”‚
    â”‚ sha256 â”‚ â”‚   Upload      â”‚ abc123 â”‚   Download    â”‚ fnv1a  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
               â”‚               â”‚ Doc A2 â”‚               â”‚ Doc B2 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚ SHA:   â”‚               â”‚ Hash:  â”‚
    â”‚ Doc A2 â”‚â”€â”˜               â”‚ def456 â”‚               â”‚ fnv1a  â”‚
    â”‚ Hash:  â”‚                 â”‚        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ sha256 â”‚                 â”‚ Doc B1 â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ SHA:   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ ghi789 â”‚      Upload
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚        â”‚
    â”‚ Local    â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Cache    â”‚                                        â”‚ Local    â”‚
    â”‚          â”‚                                        â”‚ Cache    â”‚
    â”‚ cache-   â”‚               [Truth Source]          â”‚ cache-   â”‚
    â”‚ xxx.json â”‚                                        â”‚ xxx.json â”‚
    â”‚          â”‚                                        â”‚          â”‚
    â”‚ assets-  â”‚                                        â”‚ assets-  â”‚
    â”‚ cache-   â”‚                                        â”‚ cache-   â”‚
    â”‚ 0..f     â”‚                                        â”‚ 0..f     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæ­¥å†²çªæ£€æµ‹

**æ ¸å¿ƒåŸåˆ™: GitHub SHA ä½œä¸ºçœŸç›¸æ¥æº**

```typescript
// GitHub æ–‡ä»¶å¯¹è±¡:
{
    path: "test1/hello world-3.md",
    sha: "9f8e7d6c5b4a3921...",      // GitHub blob SHA (å”¯ä¸€æ ‡è¯†)
    content: "...",                   // Base64 ç¼–ç çš„å†…å®¹
    size: 1234
}
```

---

## æ—¶åºå›¾

### 1. å¢é‡åŒæ­¥æ—¶åºå›¾ (v0.3.0)

```mermaid
sequenceDiagram
    participant Timer as Auto Sync Timer
    participant Scheduler
    participant Engine as Incremental Engine
    participant SQL as SiYuan SQL API
    participant Cache
    participant GitHub

    Timer->>Scheduler: Trigger (every N min)
    Scheduler->>Scheduler: Check isRunning
    alt Not running
        Scheduler->>Engine: performIncrementalSync()

        Engine->>SQL: Query all doc metadata
        SQL-->>Engine: 2000 docs (50KB, 100ms)

        Engine->>Cache: Load all caches
        Cache-->>Engine: Cached entries

        Engine->>Engine: Compare timestamps
        Note over Engine: Filter: 20/2000 changed

        loop For each changed doc (20)
            Engine->>SQL: exportMdContent(docId)
            SQL-->>Engine: Markdown content
            Engine->>Engine: calculateHash()

            alt Hash different
                Engine->>GitHub: Upload file
                GitHub-->>Engine: New SHA
                Engine->>Cache: Update cache
            else Hash same
                Engine->>Engine: Skip upload
            end
        end

        Engine-->>Scheduler: Result: 18 uploaded, 2 skipped
        Scheduler->>Scheduler: isRunning = false
    else Already running
        Scheduler->>Scheduler: Skip this tick
    end
```

### 2. æ–‡æ¡£é¦–æ¬¡å¯¼å‡ºæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User
    participant Plugin
    participant Cache
    participant Hash
    participant GitHub

    User->>Plugin: ç‚¹å‡» "Export current doc"
    Plugin->>Plugin: getDocInfo()
    Plugin->>Plugin: exportMarkdown()
    Plugin->>Hash: calculateHash(markdown)

    alt crypto.subtle å¯ç”¨
        Hash-->>Plugin: SHA-256 hash
    else crypto.subtle ä¸å¯ç”¨
        Hash-->>Plugin: FNV-1a hash
    end

    Plugin->>Cache: getDocCacheEntry(notebookId, docId)
    Cache-->>Plugin: null (ç¼“å­˜ä¸å­˜åœ¨)

    Plugin->>GitHub: createOrUpdateTextFile()
    GitHub-->>Plugin: { sha: "abc123" }

    Plugin->>Cache: updateDocCacheEntry()
    Cache-->>Plugin: ç¼“å­˜å·²æ›´æ–°

    Plugin->>User: "Export: done"
```

### 3. æ–‡æ¡£å†æ¬¡å¯¼å‡ºï¼ˆç¼“å­˜å‘½ä¸­ï¼‰æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User
    participant Plugin
    participant Cache
    participant Hash
    participant GitHub

    User->>Plugin: ç‚¹å‡» "Export current doc"
    Plugin->>Plugin: getDocInfo()
    Plugin->>Plugin: exportMarkdown()
    Plugin->>Hash: calculateHash(markdown)
    Hash-->>Plugin: "a3c8f9e2..." (ä¸ä¸Šæ¬¡ç›¸åŒ)

    Plugin->>Cache: getDocCacheEntry(notebookId, docId)
    Cache-->>Plugin: { contentHash: "a3c8f9e2...", githubSHA: "abc123" }

    Plugin->>Plugin: æ¯”è¾ƒå“ˆå¸Œ: ç›¸åŒ
    Plugin->>User: "Content unchanged, skipping upload"

    Note over Plugin,GitHub: âœ… è·³è¿‡GitHubä¸Šä¼ ï¼ŒèŠ‚çœæ—¶é—´
```

---

## æ•°æ®ç»“æ„è¯¦è§£

### 1. æ–‡æ¡£ç¼“å­˜æ¡ç›® (DocCacheEntry)

```typescript
interface DocCacheEntry {
    docId: string;              // æ–‡æ¡£ID
    notebookId: string;         // æ‰€å±ç¬”è®°æœ¬ID
    githubPath: string;         // GitHubä¸­çš„è·¯å¾„
    contentHash: string;        // å†…å®¹å“ˆå¸Œ (ç”¨äºæ£€æµ‹å˜åŒ–)
    githubSHA: string;          // GitHub blob SHA (ç”¨äºæ›´æ–°)
    lastSyncTime: number;       // æœ€ååŒæ­¥æ—¶é—´æˆ³
    siyuanUpdated: number;      // SiYuanæ–‡æ¡£æ›´æ–°æ—¶é—´ [v0.3.0]
}

// ç¤ºä¾‹:
{
    docId: "20241221133029-8eietj4",
    notebookId: "20241221133023-nntepeb",
    githubPath: "test1/hello world-3.md",
    contentHash: "a3c8f9e2d1b4c7a9e5f6a2b8c1d9e0f3...",  // 64 chars (SHA-256)
    githubSHA: "9f8e7d6c5b4a3921e0d8c7b6a5948372",
    lastSyncTime: 1736985600000,    // 2025-01-15 12:00:00
    siyuanUpdated: 1736985500000    // 2025-01-15 11:58:20
}
```

**å­—æ®µè¯´æ˜:**

- `contentHash`:
  - ç”¨é€”: æ£€æµ‹å†…å®¹æ˜¯å¦å˜åŒ–
  - ç®—æ³•: SHA-256 æˆ– FNV-1a (å–å†³äºç¯å¢ƒ)
  - æ¯”è¾ƒ: å½“å‰å“ˆå¸Œ vs ç¼“å­˜å“ˆå¸Œ â†’ åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸Šä¼ 

- `githubSHA`:
  - ç”¨é€”: GitHub API æ›´æ–°æ–‡ä»¶æ—¶å¿…é¡»æä¾›
  - æ¥æº: GitHub API è¿”å›
  - å†²çªæ£€æµ‹: ä¸Šä¼ æ—¶æ¯”å¯¹ GitHub å½“å‰ SHA

- `siyuanUpdated` **[v0.3.0æ–°å¢]**:
  - ç”¨é€”: å¢é‡åŒæ­¥çš„æ ¸å¿ƒå­—æ®µ
  - æ¥æº: SiYuan blocks è¡¨çš„ updated å­—æ®µ
  - æ¯”è¾ƒ: doc.updated > cached.siyuanUpdated â†’ æ–‡æ¡£å·²å˜åŒ–

### 2. èµ„æºç¼“å­˜æ¡ç›® (AssetCacheEntry)

```typescript
interface AssetCacheEntry {
    assetPath: string;          // èµ„æºè·¯å¾„ (ç›¸å¯¹äº assets/)
    contentHash: string;        // æ–‡ä»¶å“ˆå¸Œ
    githubSHA: string;          // GitHub SHA
    lastSyncTime: number;       // åŒæ­¥æ—¶é—´
    fileSize: number;           // æ–‡ä»¶å¤§å° (bytes)
    mtime: number;              // æ–‡ä»¶ä¿®æ”¹æ—¶é—´ [v0.3.0æ–°å¢]
}

// ç¤ºä¾‹:
{
    assetPath: "20210808180117-abc123.png",
    contentHash: "b4d1a8c3e7f2a9b6d5c8e1f4a7b3d0c9...",
    githubSHA: "7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d",
    lastSyncTime: 1736985650000,
    fileSize: 102400,    // 100KB
    mtime: 1736985640000 // æ–‡ä»¶ä¿®æ”¹æ—¶é—´
}
```

### 3. å¢é‡åŒæ­¥ç»“æœ (IncrementalSyncResult) **[v0.3.0æ–°å¢]**

```typescript
interface IncrementalSyncResult {
    docs: {
        scanned: number;        // æ‰«æçš„æ–‡æ¡£æ€»æ•°
        changed: number;        // å˜åŒ–çš„æ–‡æ¡£æ•°
        uploaded: number;       // æˆåŠŸä¸Šä¼ æ•°
        skipped: number;        // è·³è¿‡æ•°ï¼ˆå“ˆå¸Œç›¸åŒï¼‰
        failed: number;         // å¤±è´¥æ•°
    };
    assets: {
        scanned: number;        // æ‰«æçš„èµ„æºæ€»æ•°
        changed: number;        // å˜åŒ–çš„èµ„æºæ•°
        uploaded: number;       // æˆåŠŸä¸Šä¼ æ•°
        skipped: number;        // è·³è¿‡æ•°
        failed: number;         // å¤±è´¥æ•°
    };
}

// ç¤ºä¾‹:
{
    docs: {
        scanned: 2000,
        changed: 20,
        uploaded: 18,
        skipped: 2,
        failed: 0
    },
    assets: {
        scanned: 5000,
        changed: 5,
        uploaded: 5,
        skipped: 0,
        failed: 0
    }
}
```

### 4. è‡ªåŠ¨åŒæ­¥é…ç½® (AutoSyncConfig) **[v0.3.0æ–°å¢]**

```typescript
interface AutoSyncConfig {
    enabled: boolean;           // æ˜¯å¦å¯ç”¨è‡ªåŠ¨åŒæ­¥
    interval: number;           // åŒæ­¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    syncDocs: boolean;          // æ˜¯å¦åŒæ­¥æ–‡æ¡£
    syncAssets: boolean;        // æ˜¯å¦åŒæ­¥èµ„æº
    onlyWhenIdle: boolean;      // ä»…åœ¨ç©ºé—²æ—¶åŒæ­¥ï¼ˆæœªå®ç°ï¼‰
    maxConcurrency: number;     // æœ€å¤§å¹¶å‘æ•°
}

// ç¤ºä¾‹:
{
    enabled: true,
    interval: 30,               // 30åˆ†é’Ÿ
    syncDocs: true,
    syncAssets: true,
    onlyWhenIdle: false,
    maxConcurrency: 5
}
```

---

## è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. ç¼“å­˜æ–‡ä»¶æŸå

**åœºæ™¯:** ç¼“å­˜JSONæ–‡ä»¶æ ¼å¼é”™è¯¯

```typescript
// cache-manager.ts
async function loadNotebookDocCache(plugin: Plugin, notebookId: string) {
    try {
        const cacheFile = getNotebookCacheFile(notebookId);
        const cache = await plugin.loadData(cacheFile);
        return cache || {};  // å¦‚æœä¸ºnullï¼Œè¿”å›ç©ºå¯¹è±¡
    } catch (error) {
        // JSONè§£æå¤±è´¥ â†’ è¿”å›ç©ºç¼“å­˜
        await logError(`[Cache] Failed to load cache, resetting: ${error}`);
        return {};
    }
}

// åæœ: ç¼“å­˜é‡ç½®ï¼Œä¸‹æ¬¡ä¼šé‡æ–°ä¸Šä¼ æ‰€æœ‰æ–‡æ¡£
// å½±å“: æ€§èƒ½æŸå¤±ï¼Œä½†æ•°æ®ä¸ä¸¢å¤±
```

### 2. å“ˆå¸Œç®—æ³•é™çº§

**åœºæ™¯:** HTTPS â†’ HTTP (crypto.subtle ä¸å†å¯ç”¨)

```typescript
// hash-utils.ts
export async function calculateHash(text: string): Promise<string> {
    if (typeof crypto !== "undefined" && crypto.subtle) {
        try {
            // å°è¯• SHA-256
            return await sha256(text);
        } catch (e) {
            console.warn("[Hash] Downgrading to FNV-1a");
        }
    }
    // é™çº§åˆ° FNV-1a
    return simpleHash(text);
}

// åæœ: å“ˆå¸Œå€¼ä¸åŒ
//   æ—§: "a3c8f9e2d1b4c7a9..." (SHA-256, 64 chars)
//   æ–°: "b4d1a8c3"           (FNV-1a, 8 chars)
//
// å½±å“: ä¸‹æ¬¡åŒæ­¥ä¼šè®¤ä¸ºæ‰€æœ‰æ–‡æ¡£éƒ½å˜åŒ–äº†
//      â†’ é‡æ–°ä¸Šä¼ æ‰€æœ‰æ–‡æ¡£ (ä¸€æ¬¡æ€§å½±å“)
```

### 3. GitHub API é™æµ

**åœºæ™¯:** çŸ­æ—¶é—´å¤§é‡è¯·æ±‚ â†’ è§¦å‘é™æµ

```
GitHub API é™åˆ¶:
- è®¤è¯ç”¨æˆ·: 5000 requests/hour
- æœªè®¤è¯:   60 requests/hour
```

**v0.3.0 ä¼˜åŒ–:**
- å¢é‡åŒæ­¥å¤§å¹…å‡å°‘è¯·æ±‚æ•°ï¼ˆ2000 â†’ 40ï¼‰
- æ¯å°æ—¶å¯æ”¯æŒ 125 æ¬¡è‡ªåŠ¨åŒæ­¥ï¼ˆ5åˆ†é’Ÿé—´éš”å®Œå…¨å®‰å…¨ï¼‰

### 4. ç½‘ç»œä¸­æ–­

**åœºæ™¯:** ä¸Šä¼ è¿‡ç¨‹ä¸­ç½‘ç»œæ–­å¼€

```typescript
// exporter.ts
try {
    const uploadResult = await createOrUpdateTextFile(...);
    await updateDocCacheEntry(...);  // â† åªæœ‰ä¸Šä¼ æˆåŠŸæ‰æ›´æ–°ç¼“å­˜
} catch (error) {
    // ä¸Šä¼ å¤±è´¥ â†’ ç¼“å­˜ä¸æ›´æ–°
    await logError(`Upload failed: ${error}`);
    throw error;
}

// åæœ: ç¼“å­˜æœªæ›´æ–°
// å½±å“: ä¸‹æ¬¡é‡è¯•æ—¶ä¼šé‡æ–°ä¸Šä¼  (æ­£ç¡®è¡Œä¸º)
```

### 5. è‡ªåŠ¨åŒæ­¥é‡å  **[v0.3.0æ–°å¢]**

**åœºæ™¯:** åŒæ­¥è€—æ—¶è¶…è¿‡åŒæ­¥é—´éš”

**å¤„ç†:**
```typescript
private async runSync(): Promise<void> {
  if (this.isRunning) {
    console.warn("[AutoSync] Already running, skipping this tick");
    return;  // è·³è¿‡æœ¬æ¬¡
  }

  this.isRunning = true;
  try {
    await performIncrementalSync(...);
  } finally {
    this.isRunning = false;
  }
}
```

**ä¿è¯:** åŒä¸€æ—¶é—´æœ€å¤šä¸€ä¸ªåŒæ­¥ä»»åŠ¡è¿è¡Œ

---

## æ€§èƒ½ä¼˜åŒ–æ€»ç»“

### ç¼“å­˜å‘½ä¸­ç‡å¯¹æ¯”

**æµ‹è¯•åœºæ™¯:** 10000 ä¸ªæ–‡æ¡£ï¼Œæ¯å¤©ä¿®æ”¹ 50 ä¸ª

| åŒæ­¥æ¬¡æ•° | æ— ç¼“å­˜ | v0.2.0 | v0.3.0 å¢é‡ | ç¼“å­˜å‘½ä¸­ç‡ | æ—¶é—´èŠ‚çœ |
|---------|-------|--------|------------|-----------|---------|
| ç¬¬1æ¬¡   | ä¸Šä¼ 10000 | ä¸Šä¼ 10000 | ä¸Šä¼ 10000 | 0% | 0% |
| ç¬¬2æ¬¡   | ä¸Šä¼ 10000 | ä¸Šä¼ 50 | å¤„ç†50 | 99.5% | 99.5% |
| ç¬¬3æ¬¡   | ä¸Šä¼ 10000 | ä¸Šä¼ 20 | å¤„ç†20 | 99.8% | 99.8% |
| ç¬¬30æ¬¡  | ä¸Šä¼ 10000 | ä¸Šä¼ 10 | å¤„ç†10 | 99.9% | 99.9% |

**v0.3.0 å…³é”®æå‡:**
- ä»…æ‰«æå˜åŒ–çš„æ–‡æ¡£ï¼ˆSQLæŸ¥è¯¢ vs å…¨é‡å¯¼å‡ºï¼‰
- ä»…å¤„ç†å˜åŒ–çš„èµ„æºï¼ˆmtimeæ¯”è¾ƒ vs å…¨é‡å“ˆå¸Œï¼‰
- å‡å°‘99%çš„ç½‘ç»œè¯·æ±‚

### API è°ƒç”¨å¯¹æ¯”

**åœºæ™¯:** åŒæ­¥ 1000 ä¸ªæ–‡æ¡£ (å…¶ä¸­ 10 ä¸ªå˜åŒ–)

| æ“ä½œ | v0.1.0 | v0.2.0 | v0.3.0 | ä¼˜åŒ– |
|-----|--------|--------|--------|-----|
| æ‰«ææ–‡æ¡£ | 1000Ã—export | 1000Ã—export | 1Ã—SQL | 1000x |
| è®¡ç®—å“ˆå¸Œ | 1000 | 1000 | 10 | 100x |
| GitHub API | 1000 | 10 | 10 | 100x |
| **æ€»è€—æ—¶** | ~300s | ~240s | ~3s | **80-100x** |

---

## æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **GitHub ä½œä¸ºå”¯ä¸€çœŸç›¸æ¥æº**
   - æ‰€æœ‰å®¢æˆ·ç«¯é€šè¿‡ GitHub åŒæ­¥
   - GitHub SHA ç”¨äºå†²çªæ£€æµ‹
   - ä¸åŒå®¢æˆ·ç«¯çš„æœ¬åœ°ç¼“å­˜ç‹¬ç«‹

2. **å“ˆå¸Œç®—æ³•å¤šç¯å¢ƒå…¼å®¹**
   - ä¼˜å…ˆä½¿ç”¨ SHA-256 (å®‰å…¨ã€æ ‡å‡†)
   - é™çº§ä½¿ç”¨ FNV-1a (å…¼å®¹ã€å¿«é€Ÿ)
   - ä¸å½±å“è·¨å®¢æˆ·ç«¯åŒæ­¥

3. **åˆ†ç‰‡ç¼“å­˜æå‡æ€§èƒ½**
   - æ–‡æ¡£æŒ‰ç¬”è®°æœ¬åˆ†ç¦»
   - èµ„æºæŒ‰å“ˆå¸Œåˆ†ç‰‡ (16ä¸ª)
   - æ”¯æŒå¹¶å‘è¯»å†™

4. **å¢é‡åŒæ­¥é¿å…æµªè´¹** **[v0.3.0]**
   - åŸºäºæ—¶é—´æˆ³çš„å˜åŒ–æ£€æµ‹
   - SQLå…ƒæ•°æ®æŸ¥è¯¢é¿å…å…¨é‡å¯¼å‡º
   - ä»…å¤„ç†å˜åŒ–çš„æ–‡æ¡£å’Œèµ„æº

5. **è‡ªåŠ¨åŒæ­¥åå°è¿è¡Œ** **[v0.3.0]**
   - å¯é…ç½®çš„åŒæ­¥é—´éš”
   - å¹¶å‘æ§åˆ¶é¿å…é‡å 
   - ä¼˜é›…çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

### é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆ:**
- ä¸ªäººç¬”è®°åŒæ­¥åˆ° GitHub
- å¤šè®¾å¤‡è®¿é—® (æ¡Œé¢ç‰ˆ + Webç‰ˆ)
- è½»é‡çº§ç‰ˆæœ¬æ§åˆ¶
- èµ„æºæ–‡ä»¶å¤‡ä»½
- å¤§è§„æ¨¡ç¬”è®°åº“ï¼ˆ2000+ æ–‡æ¡£ï¼‰**[v0.3.0]**
- é¢‘ç¹è‡ªåŠ¨åŒæ­¥ï¼ˆ5-60åˆ†é’Ÿé—´éš”ï¼‰**[v0.3.0]**

âŒ **ä¸é€‚åˆ:**
- å®æ—¶åä½œ (å¤šäººåŒæ—¶ç¼–è¾‘)
- éœ€è¦ç»†ç²’åº¦å†²çªè§£å†³
- å¤§æ–‡ä»¶é¢‘ç¹ä¿®æ”¹ (>10MB)

### ç‰ˆæœ¬æ¼”è¿›

- **v0.1.0**: åŸºç¡€å¯¼å‡ºåŠŸèƒ½
  - æ‰‹åŠ¨å¯¼å‡ºæ–‡æ¡£å’Œèµ„æº
  - æ— ç¼“å­˜ï¼Œæ¯æ¬¡å…¨é‡å¤„ç†

- **v0.2.0**: ç¼“å­˜ç³»ç»Ÿ
  - å“ˆå¸Œå»é‡ï¼Œè·³è¿‡æœªå˜åŒ–æ–‡ä»¶
  - åˆ†ç‰‡ç¼“å­˜ï¼Œæå‡å¹¶å‘æ€§èƒ½
  - 30-50x æ€§èƒ½æå‡

- **v0.3.0**: å¢é‡åŒæ­¥ + è‡ªåŠ¨åŒæ­¥
  - SQLå…ƒæ•°æ®æ‰«æï¼Œé¿å…å…¨é‡å¯¼å‡º
  - æ—¶é—´æˆ³å˜åŒ–æ£€æµ‹
  - è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨
  - **18-2400x æ€§èƒ½æå‡**ï¼ˆå–å†³äºå˜åŒ–ç‡ï¼‰

- **v0.4.x**: è·¨è®¾å¤‡å…¼å®¹æ€§ + Bugä¿®å¤
  - å¤šshardæ‰«æç­–ç•¥
  - æµè§ˆå™¨ç¯å¢ƒé€‚é…
  - æ­£åˆ™è¡¨è¾¾å¼ä¿®å¤

---

## å·²çŸ¥æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. SiYuan SQL æŸ¥è¯¢é»˜è®¤é™åˆ¶

**é—®é¢˜æè¿°**ï¼š
SiYuan çš„ `/api/query/sql` æ¥å£é»˜è®¤åªè¿”å› **64 æ¡è®°å½•**ï¼Œå³ä½¿æ•°æ®åº“ä¸­æœ‰æ›´å¤šæ•°æ®ã€‚

**å½±å“**ï¼š
- å¢é‡åŒæ­¥çš„æ–‡æ¡£æ‰«æåªèƒ½è·å– 64 ç¯‡æ–‡æ¡£
- å¤§å‹ç¬”è®°åº“ï¼ˆ> 64 æ–‡æ¡£ï¼‰ä¼šæ¼æ‰éƒ¨åˆ†æ–‡æ¡£

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// incremental-sync.ts - getAllDocMetadata()
const sql = `
  SELECT id, box, path, hpath, content AS name, updated
  FROM blocks
  WHERE type = 'd'
  ORDER BY updated DESC
  LIMIT 10000  -- âœ… æ˜¾å¼æŒ‡å®š LIMITï¼Œè¦†ç›–é»˜è®¤çš„ 64
`;
```

**æ•™è®­**ï¼š
- âŒ ä¸è¦ä¾èµ– SiYuan API çš„é»˜è®¤è¡Œä¸º
- âœ… æ€»æ˜¯æ˜¾å¼æŒ‡å®š `LIMIT`ï¼ˆå»ºè®® 10000ï¼Œè¶³å¤Ÿè¦†ç›–å¤§å‹ä»“åº“ï¼‰
- âœ… åœ¨æ—¥å¿—ä¸­è®°å½•å®é™…è¿”å›çš„è®°å½•æ•°ï¼Œä¾¿äºè°ƒè¯•

### 2. æµè§ˆå™¨ç¯å¢ƒ Buffer ä¸å¯ç”¨

**é—®é¢˜æè¿°**ï¼š
SiYuan æ’ä»¶è¿è¡Œåœ¨**æµè§ˆå™¨ç¯å¢ƒ**ï¼Œä¸æ”¯æŒ Node.js çš„ `Buffer` APIã€‚

**é”™è¯¯åœºæ™¯**ï¼š
```typescript
// âŒ é”™è¯¯ä»£ç 
const content = await readAssetFile(assetPath);  // è¿”å› ArrayBuffer
const buffer = Buffer.from(content);  // ReferenceError: Buffer is not defined
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// âœ… æ­£ç¡®ä»£ç 
const content = await readAssetFile(assetPath);  // è¿”å› ArrayBuffer
await uploadToGitHub(content);  // ç›´æ¥ä½¿ç”¨ ArrayBuffer
```

**é€šç”¨åŸåˆ™**ï¼š
- âŒ é¿å…ä½¿ç”¨ Node.js ä¸“å± APIï¼š`Buffer`, `fs`, `path`, `process`
- âœ… ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ APIï¼š`ArrayBuffer`, `Uint8Array`, `Blob`, `fetch`
- âœ… ä½¿ç”¨ `crypto.subtle` ä»£æ›¿ `crypto.createHash`

### 3. crypto.subtle åœ¨ HTTP ç¯å¢ƒä¸å¯ç”¨

**é—®é¢˜æè¿°**ï¼š
`crypto.subtle` API ä»…åœ¨ **Secure Context** ä¸­å¯ç”¨ï¼š
- âœ… HTTPS
- âœ… localhost
- âŒ HTTPï¼ˆå¦‚ Docker éƒ¨ç½²çš„ SiYuanï¼‰

**å½±å“**ï¼š
- SHA-256 å“ˆå¸Œè®¡ç®—å¤±è´¥
- è‡ªåŠ¨é™çº§åˆ° FNV-1a å“ˆå¸Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// hash-utils.ts - è‡ªåŠ¨é™çº§ç­–ç•¥
export async function calculateHash(text: string): Promise<string> {
  if (typeof crypto !== "undefined" && crypto.subtle) {
    try {
      // å°è¯•ä½¿ç”¨ SHA-256
      return await sha256(text);
    } catch (e) {
      console.warn("[Hash] crypto.subtle failed, using fallback");
    }
  }
  // é™çº§åˆ° FNV-1a
  return simpleHash(text);
}
```

**åæœ**ï¼š
- HTTP ç¯å¢ƒä¸‹å“ˆå¸Œå€¼ä¸åŒï¼Œå¯¼è‡´é¦–æ¬¡åŒæ­¥é‡æ–°ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
- ä¹‹åæ­£å¸¸ä½¿ç”¨ï¼ˆFNV-1a ä»ç„¶å¯é ï¼‰

### 4. è·¨è®¾å¤‡ç¼“å­˜ Shard ä¸åŒ¹é…

**é—®é¢˜æè¿°**ï¼š
ä¸åŒç¯å¢ƒä¸‹ï¼Œå“ˆå¸Œç®—æ³•ä¸åŒå¯¼è‡´ asset shard è®¡ç®—ä¸ä¸€è‡´ï¼š
- Desktopï¼ˆHTTPSï¼‰ï¼šSHA-256 â†’ shard 7
- Dockerï¼ˆHTTPï¼‰ï¼šFNV-1a â†’ shard 4

**å½±å“**ï¼š
- ç¼“å­˜æ–‡ä»¶å·²åŒæ­¥ï¼Œä½†æŸ¥æ‰¾å¤±è´¥
- æ‰€æœ‰ assets è¢«æ ‡è®°ä¸º "New asset (no cache)"

**è§£å†³æ–¹æ¡ˆï¼ˆv0.4.0ï¼‰**ï¼š
å¤š shard æ‰«æç­–ç•¥ï¼š
1. ä¼˜å…ˆæŸ¥æ‰¾è®¡ç®—çš„ shardï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
2. æŸ¥æ‰¾å¤±è´¥æ—¶æ‰«ææ‰€æœ‰ 16 ä¸ª shardsï¼ˆå…¼å®¹è·¯å¾„ï¼‰
3. æ€§èƒ½å½±å“æå°ï¼ˆä»…é¦–æ¬¡è§¦å‘ï¼‰

### 5. æ­£åˆ™è¡¨è¾¾å¼é‡å¤åŒ¹é…é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
å›¾ç‰‡é“¾æ¥å¤„ç†æ­£åˆ™ä¼šé‡å¤åŒ¹é…å·²å¤„ç†çš„é“¾æ¥ï¼š
```typescript
// âŒ é”™è¯¯
markdown.replace(/\[([^\]]*?)\]\((\.\.\/assets\/[^)]+)\)/g, '![$1]($2)');
// ç»“æœï¼š![image](...) â†’ !![image](...)
```

**è§£å†³æ–¹æ¡ˆï¼ˆv0.4.1ï¼‰**ï¼š
ä½¿ç”¨è´Ÿå‘åé¡¾æ–­è¨€ï¼š
```typescript
// âœ… æ­£ç¡®
markdown.replace(/(?<!!)\[([^\]]*?)\]\((\.\.\/assets\/[^)]+)\)/g, '![$1]($2)');
```

### 6. GitHub API Rate Limit

**é—®é¢˜æè¿°**ï¼š
GitHub API æœ‰é€Ÿç‡é™åˆ¶ï¼š
- è®¤è¯ç”¨æˆ·ï¼š5000 requests/hour
- æœªè®¤è¯ç”¨æˆ·ï¼š60 requests/hour

**å½±å“**ï¼š
- é¢‘ç¹è‡ªåŠ¨åŒæ­¥å¯èƒ½è§¦å‘é™æµ
- v0.3.0 å¢é‡åŒæ­¥å¤§å¹…å‡å°‘è¯·æ±‚ï¼ˆ2000 â†’ 40/æ¬¡ï¼‰

**å»ºè®®**ï¼š
- æœ€å°åŒæ­¥é—´éš”ï¼š5 åˆ†é’Ÿï¼ˆå®‰å…¨ï¼‰
- ç›‘æ§ API é…é¢ï¼šGitHub å“åº”å¤´ `X-RateLimit-Remaining`

### 7. å¤šç«¯å¹¶å‘å†™å…¥å†²çªï¼ˆâœ… å·²è§£å†³ï¼‰

**é—®é¢˜æè¿°**ï¼š
å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å‘ GitHub å†™å…¥å¯èƒ½å¯¼è‡´ï¼š
- æäº¤å†²çª
- ç¼“å­˜ä¸ä¸€è‡´
- SHA æ ¡éªŒå¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼ˆv0.4.3ï¼‰**ï¼š
åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶ï¼š
1. GitHub é”æ–‡ä»¶ `.sync-in-progress` + TTL
2. æœ€è¿‘ commit æ—¶é—´æ£€æŸ¥
3. éšæœº Jitter ç­‰å¾…
4. åŒé‡æ£€æŸ¥æ¨¡å¼
5. å¼ºåˆ¶åŒæ­¥é€‰é¡¹

è¯¦è§æœ¬æ–‡æ¡£ "v0.4.3 åˆ†å¸ƒå¼åŒæ­¥é”æœºåˆ¶" ç« èŠ‚ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬:** v4.0.0
**æœ€åæ›´æ–°:** 2026-01-24
**ä½œè€…:** Claude Code
