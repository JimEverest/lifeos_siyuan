# LifeOS Sync - åŒæ­¥æœºåˆ¶è¯¦è§£

**ç‰ˆæœ¬**: v0.4.4
**æœ€åæ›´æ–°**: 2026-01-24

---

## ç›®å½•

1. [æ•°æ®å­˜å‚¨æ¶æ„](#æ•°æ®å­˜å‚¨æ¶æ„)
2. [åŒæ­¥å†å²ç³»ç»Ÿ](#åŒæ­¥å†å²ç³»ç»Ÿ)
3. [åŒæ­¥ä»ªè¡¨æ¿æ•°æ®](#åŒæ­¥ä»ªè¡¨æ¿æ•°æ®)
4. [å¤šç«¯æ•°æ®ä¸€è‡´æ€§](#å¤šç«¯æ•°æ®ä¸€è‡´æ€§)
5. [æ•°æ®æµå‘å›¾](#æ•°æ®æµå‘å›¾)
6. [å·²çŸ¥é™åˆ¶ä¸è§£å†³æ–¹æ¡ˆ](#å·²çŸ¥é™åˆ¶ä¸è§£å†³æ–¹æ¡ˆ)

---

## æ•°æ®å­˜å‚¨æ¶æ„

### å­˜å‚¨ä½ç½®æ€»è§ˆ

```
data/storage/petal/lifeos_sync/
â”‚
â”œâ”€â”€ ğŸ”„ è¢«æ€æºåŒæ­¥çš„æ•°æ® (plugin.saveData)
â”‚   â”œâ”€â”€ sync-history.json        # åŒæ­¥å†å²è®°å½•
â”‚   â”œâ”€â”€ sync-stats.json          # åŒæ­¥ç»Ÿè®¡æ•°æ®
â”‚   â”œâ”€â”€ settings.json            # æ’ä»¶è®¾ç½®
â”‚   â”œâ”€â”€ cache-{notebookId}.json  # æ–‡æ¡£ç¼“å­˜ï¼ˆæŒ‰ç¬”è®°æœ¬åˆ†ç‰‡ï¼‰
â”‚   â”œâ”€â”€ assets-{0-f}.json        # èµ„æºç¼“å­˜ï¼ˆ16è·¯åˆ†ç‰‡ï¼‰
â”‚   â”œâ”€â”€ sync-meta.json           # å…¨å±€å…ƒæ•°æ®
â”‚   â””â”€â”€ last-asset-sync-time     # èµ„æºæœ€ååŒæ­¥æ—¶é—´
â”‚
â”œâ”€â”€ ğŸ”’ ä¸è¢«æ€æºåŒæ­¥çš„æ•°æ® (localStorage) - æµè§ˆå™¨çº§åˆ«ï¼Œæ‰€æœ‰Tabå…±äº«
â”‚   â”œâ”€â”€ lifeos-sync-device-id    # è®¾å¤‡å”¯ä¸€æ ‡è¯† (UUID)
â”‚   â”œâ”€â”€ lifeos-sync-device-name  # è®¾å¤‡åç§°
â”‚   â”œâ”€â”€ lifeos-sync-device-created # è®¾å¤‡åˆ›å»ºæ—¶é—´
â”‚   â””â”€â”€ lifeos-sync-tab-counter  # Tabç¼–å·è®¡æ•°å™¨
â”‚
â””â”€â”€ ğŸ”’ ä¸è¢«æ€æºåŒæ­¥çš„æ•°æ® (sessionStorage) - Tabçº§åˆ«ï¼Œæ¯ä¸ªTabç‹¬ç«‹
    â”œâ”€â”€ lifeos-sync-tab-id       # Tabå”¯ä¸€æ ‡è¯† (8å­—ç¬¦)
    â”œâ”€â”€ lifeos-sync-tab-name     # Tabåç§° (å¦‚ "#3")
    â””â”€â”€ lifeos-sync-tab-created  # Tabåˆ›å»ºæ—¶é—´
```

### å­˜å‚¨æ–¹å¼å¯¹æ¯”

| æ•°æ®ç±»å‹ | å­˜å‚¨æ–¹å¼ | è¢«æ€æºåŒæ­¥ | ä½œç”¨åŸŸ | è¯´æ˜ |
|---------|---------|-----------|--------|------|
| è®¾å¤‡ ID | localStorage | âŒ å¦ | æµè§ˆå™¨ | æ¯ä¸ªæµè§ˆå™¨ç‹¬ç«‹çš„å”¯ä¸€æ ‡è¯† |
| è®¾å¤‡åç§° | localStorage | âŒ å¦ | æµè§ˆå™¨ | ç”¨æˆ·è‡ªå®šä¹‰çš„è®¾å¤‡å |
| Tabè®¡æ•°å™¨ | localStorage | âŒ å¦ | æµè§ˆå™¨ | ç”¨äºç”Ÿæˆé€’å¢çš„Tabç¼–å· |
| Tab ID | sessionStorage | âŒ å¦ | å•ä¸ªTab | æ¯ä¸ªæ ‡ç­¾é¡µç‹¬ç«‹çš„8å­—ç¬¦ID |
| Tabåç§° | sessionStorage | âŒ å¦ | å•ä¸ªTab | Tabç¼–å·ï¼Œå¦‚ "#3" |
| åŒæ­¥å†å² | plugin.saveData | âœ… æ˜¯ | å…¨å±€ | æ‰€æœ‰è®¾å¤‡çš„åŒæ­¥è®°å½• |
| ç»Ÿè®¡æ•°æ® | plugin.saveData | âœ… æ˜¯ | å…¨å±€ | ç´¯è®¡ç»Ÿè®¡å’Œè®¾å¤‡æ´»åŠ¨ |
| ç¼“å­˜æ•°æ® | plugin.saveData | âœ… æ˜¯ | å…¨å±€ | æ–‡æ¡£/èµ„æºçš„å“ˆå¸Œå’ŒSHA |
| æ’ä»¶è®¾ç½® | plugin.saveData | âœ… æ˜¯ | å…¨å±€ | ç”¨æˆ·é…ç½® |

### Tab ä¼šè¯æ ‡è¯†ï¼ˆv0.4.4ï¼‰

å¯¹äº Docker éƒ¨ç½²çš„æ€æºç¬”è®°ï¼Œç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æ—¶ï¼ŒåŒä¸€æµè§ˆå™¨çš„ä¸åŒæ ‡ç­¾é¡µä¼šå…±äº« localStorageã€‚ä¸ºäº†åŒºåˆ†è¿™äº›æ ‡ç­¾é¡µï¼Œv0.4.4 å¼•å…¥äº† Tab ä¼šè¯æ ‡è¯†ï¼š

```
åŒä¸€æµè§ˆå™¨ï¼ˆChromeï¼‰çš„ä¸¤ä¸ªTabï¼š
â”œâ”€â”€ Tab 1: Browser-192.168.1.1 #1 (device: a1b2c3d4, tab: xyz12345)
â””â”€â”€ Tab 2: Browser-192.168.1.1 #2 (device: a1b2c3d4, tab: abc67890)

ä¸åŒæµè§ˆå™¨ï¼š
â”œâ”€â”€ Chrome: Browser-192.168.1.1 #1 (device: a1b2c3d4)
â””â”€â”€ Safari: Browser-192.168.1.1 #1 (device: e5f6g7h8)  â† ä¸åŒçš„ device ID
```

**å·¥ä½œåŸç†**ï¼š
1. **Device ID**ï¼ˆlocalStorageï¼‰ï¼šåŒä¸€æµè§ˆå™¨çš„æ‰€æœ‰Tabå…±äº«
2. **Tab ID**ï¼ˆsessionStorageï¼‰ï¼šæ¯ä¸ªTabç‹¬ç«‹ï¼Œå…³é—­Tabåä¸¢å¤±
3. **Tab Number**ï¼šä½¿ç”¨ localStorage ä¸­çš„è®¡æ•°å™¨é€’å¢åˆ†é…

**æ˜¾ç¤ºåç§°æ ¼å¼**ï¼š
- Electron æ¡Œé¢ç‰ˆï¼š`Desktop-Windows`ï¼ˆæ— Tabç¼–å·ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçª—å£ï¼‰
- æµè§ˆå™¨è®¿é—®ï¼š`Browser-192.168.1.1 #3`ï¼ˆåŒ…å«Tabç¼–å·ï¼‰

---

## åŒæ­¥å†å²ç³»ç»Ÿ

### æ•°æ®ç»“æ„

**æ–‡ä»¶**: `sync-history.json`

```typescript
interface SyncHistoryData {
  records: SyncHistoryRecord[];  // å†å²è®°å½•æ•°ç»„
  maxRecords: number;            // æœ€å¤§ä¿å­˜æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
  lastUpdated: number;           // æœ€åæ›´æ–°æ—¶é—´æˆ³
}

interface SyncHistoryRecord {
  id: string;                    // å”¯ä¸€ID: "{timestamp}-{deviceIdå‰8ä½}-{tabId}"
  timestamp: number;             // åŒæ­¥å¼€å§‹æ—¶é—´æˆ³
  deviceId: string;              // è®¾å¤‡å®Œæ•´UUID
  deviceName: string;            // æ˜¾ç¤ºåç§°ï¼ˆå«Tabæ ‡è¯†ï¼Œå¦‚ "Browser-192.168.1.1 #3"ï¼‰
  tabId?: string;                // Tabä¼šè¯IDï¼ˆä»…æµè§ˆå™¨ç¯å¢ƒï¼‰
  tabName?: string;              // Tabåç§°ï¼ˆå¦‚ "#3"ï¼Œä»…æµè§ˆå™¨ç¯å¢ƒï¼‰
  triggerType: 'auto' | 'manual' | 'force';  // è§¦å‘ç±»å‹

  // æ–‡æ¡£åŒæ­¥ç»“æœ
  docsScanned: number;           // æ‰«æçš„æ–‡æ¡£æ•°
  docsChanged: number;           // å˜åŒ–çš„æ–‡æ¡£æ•°
  docsUploaded: number;          // ä¸Šä¼ çš„æ–‡æ¡£æ•°
  docsSkipped: number;           // è·³è¿‡çš„æ–‡æ¡£æ•°ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
  docsFailed: number;            // å¤±è´¥çš„æ–‡æ¡£æ•°

  // èµ„æºåŒæ­¥ç»“æœ
  assetsScanned: number;         // æ‰«æçš„èµ„æºæ•°
  assetsChanged: number;         // å˜åŒ–çš„èµ„æºæ•°
  assetsUploaded: number;        // ä¸Šä¼ çš„èµ„æºæ•°
  assetsSkipped: number;         // è·³è¿‡çš„èµ„æºæ•°
  assetsFailed: number;          // å¤±è´¥çš„èµ„æºæ•°

  duration: number;              // åŒæ­¥è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  success: boolean;              // æ˜¯å¦æˆåŠŸ
  skippedReason?: string;        // è·³è¿‡åŸå› ï¼ˆå¦‚è¢«é”é˜»æ­¢ï¼‰
  errorMessage?: string;         // é”™è¯¯ä¿¡æ¯
}
```

### ç¤ºä¾‹æ•°æ®

```json
{
  "records": [
    {
      "id": "1706123456789-a1b2c3d4-xyz12345",
      "timestamp": 1706123456789,
      "deviceId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "deviceName": "Browser-192.168.1.1 #3",
      "tabId": "xyz12345",
      "tabName": "#3",
      "triggerType": "auto",
      "docsScanned": 2000,
      "docsChanged": 15,
      "docsUploaded": 15,
      "docsSkipped": 0,
      "docsFailed": 0,
      "assetsScanned": 2500,
      "assetsChanged": 3,
      "assetsUploaded": 3,
      "assetsSkipped": 0,
      "assetsFailed": 0,
      "duration": 4523,
      "success": true
    },
    {
      "id": "1706123000000-b2c3d4e5",
      "timestamp": 1706123000000,
      "deviceId": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
      "deviceName": "Desktop-Windows",
      "triggerType": "auto",
      "docsScanned": 0,
      "docsChanged": 0,
      "docsUploaded": 0,
      "docsSkipped": 0,
      "docsFailed": 0,
      "assetsScanned": 0,
      "assetsChanged": 0,
      "assetsUploaded": 0,
      "assetsSkipped": 0,
      "assetsFailed": 0,
      "duration": 0,
      "success": false,
      "skippedReason": "Last sync 3m ago (threshold: 10m)"
    }
  ],
  "maxRecords": 100,
  "lastUpdated": 1706123456789
}
```

### è®°å½•è§¦å‘æ—¶æœº

| åœºæ™¯ | triggerType | success | è¯´æ˜ |
|------|-------------|---------|------|
| è‡ªåŠ¨åŒæ­¥æˆåŠŸ | `auto` | `true` | å®šæ—¶è§¦å‘çš„åŒæ­¥å®Œæˆ |
| è‡ªåŠ¨åŒæ­¥å¤±è´¥ | `auto` | `false` | ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸ |
| è‡ªåŠ¨åŒæ­¥è·³è¿‡ | `auto` | `false` | è¢«é”é˜»æ­¢æˆ–æ—¶é—´æ£€æŸ¥æœªé€šè¿‡ |
| æ‰‹åŠ¨å¯¼å‡º | `manual` | - | å•æ–‡æ¡£å¯¼å‡ºï¼ˆæš‚æœªè®°å½•ï¼‰ |
| å¼ºåˆ¶åŒæ­¥æˆåŠŸ | `force` | `true` | ç”¨æˆ·ç¡®è®¤çš„å¼ºåˆ¶åŒæ­¥ |
| å¼ºåˆ¶åŒæ­¥å¤±è´¥ | `force` | `false` | å¼ºåˆ¶åŒæ­¥å‡ºé”™ |

---

## åŒæ­¥ä»ªè¡¨æ¿æ•°æ®

### æ•°æ®ç»“æ„

**æ–‡ä»¶**: `sync-stats.json`

```typescript
interface SyncStatistics {
  // ç´¯è®¡ç»Ÿè®¡ï¼ˆè‡ªé¦–æ¬¡ä½¿ç”¨ä»¥æ¥ï¼‰
  totalDocsUploaded: number;     // æ€»ä¸Šä¼ æ–‡æ¡£æ•°
  totalAssetsUploaded: number;   // æ€»ä¸Šä¼ èµ„æºæ•°
  totalSyncCount: number;        // æ€»åŒæ­¥æ¬¡æ•°
  totalSyncTime: number;         // æ€»åŒæ­¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

  // ç¼“å­˜ç»Ÿè®¡
  cacheHits: number;             // ç¼“å­˜å‘½ä¸­æ¬¡æ•°
  cacheMisses: number;           // ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°

  // è®¾å¤‡ç»Ÿè®¡
  deviceSyncStats: {
    [deviceId: string]: {
      deviceName: string;        // è®¾å¤‡åç§°
      lastSyncTime: number;      // æœ€ååŒæ­¥æ—¶é—´
      syncCount: number;         // è¯¥è®¾å¤‡åŒæ­¥æ¬¡æ•°
    };
  };

  // æœ€è¿‘ç»Ÿè®¡ï¼ˆåŠ¨æ€è®¡ç®—ï¼Œè¿‡å»24å°æ—¶ï¼‰
  recentDocsUploaded: number;    // 24å°æ—¶å†…ä¸Šä¼ æ–‡æ¡£æ•°
  recentAssetsUploaded: number;  // 24å°æ—¶å†…ä¸Šä¼ èµ„æºæ•°
  recentSyncCount: number;       // 24å°æ—¶å†…åŒæ­¥æ¬¡æ•°

  // å…ƒæ•°æ®
  firstSyncTime: number;         // é¦–æ¬¡åŒæ­¥æ—¶é—´
  lastSyncTime: number;          // æœ€ååŒæ­¥æ—¶é—´
  lastUpdated: number;           // æ•°æ®æœ€åæ›´æ–°æ—¶é—´
}
```

### ç¤ºä¾‹æ•°æ®

```json
{
  "totalDocsUploaded": 1523,
  "totalAssetsUploaded": 456,
  "totalSyncCount": 89,
  "totalSyncTime": 345678,
  "cacheHits": 178456,
  "cacheMisses": 1979,
  "deviceSyncStats": {
    "a1b2c3d4-e5f6-7890-abcd-ef1234567890": {
      "deviceName": "Desktop-Windows",
      "lastSyncTime": 1706123456789,
      "syncCount": 45
    },
    "b2c3d4e5-f6a7-8901-bcde-f23456789012": {
      "deviceName": "Docker-Server",
      "lastSyncTime": 1706123000000,
      "syncCount": 44
    }
  },
  "recentDocsUploaded": 23,
  "recentAssetsUploaded": 5,
  "recentSyncCount": 12,
  "firstSyncTime": 1705000000000,
  "lastSyncTime": 1706123456789,
  "lastUpdated": 1706123456789
}
```

### ä»ªè¡¨æ¿æ˜¾ç¤ºå†…å®¹

| å¡ç‰‡ | æ•°æ®æ¥æº | è®¡ç®—æ–¹å¼ |
|------|---------|---------|
| Docs Uploaded | `totalDocsUploaded` | ç´¯åŠ æ‰€æœ‰æˆåŠŸè®°å½•çš„ `docsUploaded` |
| Assets Uploaded | `totalAssetsUploaded` | ç´¯åŠ æ‰€æœ‰æˆåŠŸè®°å½•çš„ `assetsUploaded` |
| Total Syncs | `totalSyncCount` | æˆåŠŸçš„åŒæ­¥æ¬¡æ•° |
| Cache Hit Rate | `cacheHits / (cacheHits + cacheMisses)` | è·³è¿‡æ•°/æ€»å¤„ç†æ•° |
| Today ç»Ÿè®¡ | `recentXxx` | è¿‡æ»¤ `timestamp > now - 24h` çš„è®°å½• |
| Device Activity | `deviceSyncStats` | æ¯ä¸ªè®¾å¤‡çš„ç‹¬ç«‹è®¡æ•° |

---

## å¤šç«¯æ•°æ®ä¸€è‡´æ€§

### æ•°æ®åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤šç«¯å†å²æ•°æ®åŒæ­¥æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Device A (Desktop)              SiYuan Cloud              Device B (Docker)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ 1. æ‰§è¡ŒåŒæ­¥    â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ â†“              â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ 2. å†™å…¥å†å²    â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚    è®°å½• A1     â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ â†“              â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ 3. saveData()  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ å­˜å‚¨       â”‚            â”‚                â”‚
  â”‚                â”‚             â”‚ history    â”‚            â”‚                â”‚
  â”‚                â”‚             â”‚ [A1]       â”‚            â”‚                â”‚
  â”‚                â”‚             â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 4. SiYuanåŒæ­¥   â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ â†“              â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ 5. è·å– [A1]   â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ â†“              â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ 6. æ‰§è¡ŒåŒæ­¥    â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ â†“              â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ 7. åŠ è½½ [A1]   â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚    æ·»åŠ  B1     â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚ â†“              â”‚
  â”‚                â”‚             â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 8. saveData()  â”‚
  â”‚                â”‚             â”‚ å­˜å‚¨       â”‚            â”‚    [A1, B1]    â”‚
  â”‚                â”‚             â”‚ history    â”‚            â”‚                â”‚
  â”‚ 9. SiYuanåŒæ­¥  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ [A1, B1]   â”‚            â”‚                â”‚
  â”‚ â†“              â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚ 10. è·å–       â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚    [A1, B1]    â”‚             â”‚            â”‚            â”‚                â”‚
  â”‚                â”‚             â”‚            â”‚            â”‚                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®°å½• ID è®¾è®¡

ä¸ºé¿å…å†²çªï¼Œæ¯æ¡è®°å½•çš„ ID æ ¼å¼ä¸ºï¼š

**æ¡Œé¢ç‰ˆï¼ˆElectronï¼‰**ï¼š
```
{timestamp}-{deviceIdå‰8ä½}
```

**æµè§ˆå™¨ç‰ˆï¼ˆDocker/è¿œç¨‹è®¿é—®ï¼‰**ï¼š
```
{timestamp}-{deviceIdå‰8ä½}-{tabId}
```

ç¤ºä¾‹ï¼š
- `1706123456789-a1b2c3d4` (Desktop-Windows çš„è®°å½•)
- `1706123456790-b2c3d4e5-xyz12345` (Browser #3 çš„è®°å½•)
- `1706123456791-b2c3d4e5-abc67890` (Browser #5 çš„è®°å½•ï¼ŒåŒä¸€æµè§ˆå™¨ä¸åŒTab)

**ä¼˜ç‚¹**ï¼š
- å³ä½¿ä¸¤ä¸ªè®¾å¤‡åŒæ—¶å†™å…¥ï¼ŒID ä¹Ÿä¸ä¼šå†²çª
- åŒä¸€æµè§ˆå™¨ä¸åŒTabçš„è®°å½•ä¹Ÿä¸ä¼šå†²çª
- å¯ä»¥æŒ‰æ—¶é—´æ’åº
- å¯ä»¥è¿½æº¯æ¥æºè®¾å¤‡å’ŒTab

### æ•°æ®åˆå¹¶ç­–ç•¥

å½“å‰å®ç°é‡‡ç”¨**åå†™å…¥è¦†ç›–**ç­–ç•¥ï¼š

```typescript
// sync-history.ts - addSyncRecord()
async function addSyncRecord(plugin, result, triggerType, ...) {
  // 1. åŠ è½½ç°æœ‰å†å²ï¼ˆåŒ…å«å…¶ä»–è®¾å¤‡çš„è®°å½•ï¼‰
  const history = await loadSyncHistory(plugin);

  // 2. æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´
  history.records.unshift(newRecord);

  // 3. é™åˆ¶è®°å½•æ•°é‡
  if (history.records.length > 100) {
    history.records = history.records.slice(0, 100);
  }

  // 4. ä¿å­˜ï¼ˆä¼šè§¦å‘æ€æºåŒæ­¥ï¼‰
  await saveSyncHistory(plugin, history);
}
```

**å·¥ä½œåŸç†**ï¼š
1. æ¯æ¬¡å†™å…¥å‰å…ˆåŠ è½½æœ€æ–°æ•°æ®
2. æ–°è®°å½•æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
3. ä¿å­˜æ—¶ä¿ç•™æ‰€æœ‰è®¾å¤‡çš„è®°å½•
4. æ€æºåŒæ­¥ä¼šå°†æ›´æ–°ä¼ æ’­åˆ°å…¶ä»–è®¾å¤‡

### æ½œåœ¨çš„æ•°æ®ä¸¢å¤±åœºæ™¯

```
æ—¶é—´çº¿ï¼š
T1: Device A åŠ è½½å†å² [X, Y, Z]
T2: Device B åŠ è½½å†å² [X, Y, Z]
T3: Device A æ·»åŠ è®°å½• A1ï¼Œä¿å­˜ [A1, X, Y, Z]
T4: Device B æ·»åŠ è®°å½• B1ï¼Œä¿å­˜ [B1, X, Y, Z]  â† ä¸¢å¤± A1ï¼
T5: æ€æºåŒæ­¥ï¼ŒDevice A è·å– [B1, X, Y, Z]     â† A1 è¢«è¦†ç›–
```

**ç¼“è§£æªæ–½**ï¼š
1. **åˆ†å¸ƒå¼é”æœºåˆ¶**ï¼šv0.4.3 å®ç°çš„é”æœºåˆ¶å¤§å¹…é™ä½äº†åŒæ—¶åŒæ­¥çš„æ¦‚ç‡
2. **æ—¶é—´æ£€æŸ¥**ï¼šå¦‚æœæœ€è¿‘æœ‰äººåŒæ­¥ï¼Œå½“å‰è®¾å¤‡ä¼šè·³è¿‡
3. **Jitter**ï¼šéšæœºç­‰å¾…è¿›ä¸€æ­¥åˆ†æ•£åŒæ­¥æ—¶é—´

**å®é™…å½±å“**ï¼š
- åœ¨æ­£å¸¸ä½¿ç”¨åœºæ™¯ä¸‹ï¼ˆé”æœºåˆ¶å¯ç”¨ï¼‰ï¼Œæ•°æ®ä¸¢å¤±æ¦‚ç‡æä½
- å³ä½¿ä¸¢å¤±ï¼Œä¹Ÿåªæ˜¯ä¸¢å¤±ä¸€æ¡å†å²è®°å½•ï¼Œä¸å½±å“å®é™…åŒæ­¥

---

## æ•°æ®æµå‘å›¾

### åŒæ­¥æ‰§è¡Œæ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒæ­¥æ‰§è¡Œå®Œæ•´æ•°æ®æµ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è§¦å‘ / å®šæ—¶è§¦å‘
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AutoSyncScheduler â”‚
â”‚ runSync()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ performIncrementalSyncWithLock()  â”‚
â”‚ (incremental-sync.ts)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â–º acquireSyncLock()
         â”‚      â”œâ”€â”€ æ£€æŸ¥ .sync-in-progress
         â”‚      â”œâ”€â”€ æ£€æŸ¥ last commit time
         â”‚      â”œâ”€â”€ Jitter ç­‰å¾…
         â”‚      â””â”€â”€ åˆ›å»ºé”æ–‡ä»¶
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ performIncrementalâ”‚
â”‚ Sync()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â–º æ‰«ææ–‡æ¡£ (SQLæŸ¥è¯¢)
         â”‚      â””â”€â”€ ç»“æœ: docsScanned
         â”‚
         â”œâ”€â”€â”€â”€â–º æ£€æŸ¥å˜åŒ– (æ—¶é—´æˆ³æ¯”è¾ƒ)
         â”‚      â””â”€â”€ ç»“æœ: docsChanged
         â”‚
         â”œâ”€â”€â”€â”€â–º ä¸Šä¼ æ–‡æ¡£
         â”‚      â”œâ”€â”€ æˆåŠŸ: docsUploaded++
         â”‚      â”œâ”€â”€ è·³è¿‡: docsSkipped++ (ç¼“å­˜å‘½ä¸­)
         â”‚      â””â”€â”€ å¤±è´¥: docsFailed++
         â”‚
         â”œâ”€â”€â”€â”€â–º æ‰«æèµ„æº
         â”œâ”€â”€â”€â”€â–º æ£€æŸ¥å˜åŒ–
         â””â”€â”€â”€â”€â–º ä¸Šä¼ èµ„æº
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ è¿”å›ç»“æœ      â”‚
         â”‚ Incremental  â”‚
         â”‚ SyncResult   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addSyncRecord()                   â”‚
â”‚ (sync-history.ts)                 â”‚
â”‚                                   â”‚
â”‚ 1. åŠ è½½ sync-history.json         â”‚
â”‚ 2. åˆ›å»º SyncHistoryRecord         â”‚
â”‚ 3. æ·»åŠ åˆ° records æ•°ç»„             â”‚
â”‚ 4. ä¿å­˜ sync-history.json         â”‚
â”‚                                   â”‚
â”‚ 5. æ›´æ–° sync-stats.json           â”‚
â”‚    - totalDocsUploaded++          â”‚
â”‚    - cacheHits += skipped         â”‚
â”‚    - deviceSyncStats[deviceId]++  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ releaseSyncLock()
         â”‚ åˆ é™¤ .sync-in-progress
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»ªè¡¨æ¿æ•°æ®è¯»å–æµç¨‹

```
ç”¨æˆ·ç‚¹å‡» "ğŸ“Š Sync Dashboard"
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ openSyncDashboard â”‚
â”‚ (sync-dashboard.ts)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â–º loadSyncStatistics()
         â”‚      â””â”€â”€ è¯»å– sync-stats.json
         â”‚          {
         â”‚            totalDocsUploaded: 1523,
         â”‚            cacheHits: 178456,
         â”‚            deviceSyncStats: {...}
         â”‚          }
         â”‚
         â”œâ”€â”€â”€â”€â–º getRecentRecords(20)
         â”‚      â””â”€â”€ è¯»å– sync-history.json
         â”‚          â””â”€â”€ è¿”å›å‰ 20 æ¡è®°å½•
         â”‚
         â”œâ”€â”€â”€â”€â–º calculateCacheHitRate()
         â”‚      â””â”€â”€ cacheHits / (cacheHits + cacheMisses)
         â”‚
         â””â”€â”€â”€â”€â–º æ¸²æŸ“ UI
                â”œâ”€â”€ ç»Ÿè®¡å¡ç‰‡
                â”œâ”€â”€ è®¾å¤‡æ´»åŠ¨è¡¨æ ¼
                â””â”€â”€ å†å²è®°å½•è¡¨æ ¼
```

---

## å·²çŸ¥é™åˆ¶ä¸è§£å†³æ–¹æ¡ˆ

### 1. å†å²è®°å½•å¯èƒ½ä¸¢å¤±

**é—®é¢˜**ï¼šä¸¤ä¸ªè®¾å¤‡åŒæ—¶å†™å…¥å†å²æ—¶ï¼Œåå†™å…¥çš„ä¼šè¦†ç›–å…ˆå†™å…¥çš„ã€‚

**å½“å‰ç¼“è§£**ï¼š
- åˆ†å¸ƒå¼é”æœºåˆ¶é™ä½åŒæ—¶å†™å…¥æ¦‚ç‡
- æ—¶é—´æ£€æŸ¥ + Jitter è¿›ä¸€æ­¥åˆ†æ•£

**æœªæ¥æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```typescript
// æ–¹æ¡ˆ Aï¼šåŸºäº ID çš„åˆå¹¶ç­–ç•¥
async function addSyncRecord(plugin, newRecord) {
  const history = await loadSyncHistory(plugin);

  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
  if (history.records.find(r => r.id === newRecord.id)) {
    return; // å·²å­˜åœ¨ï¼Œè·³è¿‡
  }

  // åˆå¹¶å¹¶æŒ‰æ—¶é—´æ’åº
  history.records.push(newRecord);
  history.records.sort((a, b) => b.timestamp - a.timestamp);
  history.records = history.records.slice(0, 100);

  await saveSyncHistory(plugin, history);
}
```

### 2. ç»Ÿè®¡æ•°æ®å¯èƒ½ä¸å‡†ç¡®

**é—®é¢˜**ï¼š`totalDocsUploaded` ç­‰ç´¯è®¡ç»Ÿè®¡å¯èƒ½å› è¦†ç›–è€Œä¸¢å¤±ã€‚

**å½“å‰çŠ¶æ€**ï¼šå¯æ¥å—ï¼ˆç»Ÿè®¡ä»…ä¾›å‚è€ƒï¼‰

**æœªæ¥æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```typescript
// æ–¹æ¡ˆï¼šåŸºäºå†å²è®°å½•é‡æ–°è®¡ç®—ç»Ÿè®¡
async function recalculateAllStats(plugin) {
  const history = await loadSyncHistory(plugin);
  const stats = createEmptyStats();

  for (const record of history.records) {
    if (record.success) {
      stats.totalDocsUploaded += record.docsUploaded;
      stats.totalAssetsUploaded += record.assetsUploaded;
      // ... å…¶ä»–å­—æ®µ
    }
  }

  await saveSyncStatistics(plugin, stats);
}
```

### 3. è®¾å¤‡æ´»åŠ¨å¯èƒ½ä¸å®Œæ•´

**é—®é¢˜**ï¼šå¦‚æœæŸä¸ªè®¾å¤‡çš„è®°å½•è¢«è¦†ç›–ï¼Œå…¶åœ¨ `deviceSyncStats` ä¸­çš„ç»Ÿè®¡ä¹Ÿä¼šä¸¢å¤±ã€‚

**å½“å‰ç¼“è§£**ï¼šè®¾å¤‡ç»Ÿè®¡ä¼šéšç€æ–°åŒæ­¥é€æ¸æ¢å¤

### 4. æœ€å¤§è®°å½•æ•°é™åˆ¶

**å½“å‰è®¾ç½®**ï¼š100 æ¡è®°å½•

**å½±å“**ï¼š
- é«˜é¢‘åŒæ­¥ï¼ˆ5åˆ†é’Ÿé—´éš”ï¼‰çº¦ä¿ç•™ 8 å°æ—¶å†å²
- ä½é¢‘åŒæ­¥ï¼ˆ30åˆ†é’Ÿé—´éš”ï¼‰çº¦ä¿ç•™ 50 å°æ—¶å†å²

**å¯é…ç½®æ–¹æ¡ˆ**ï¼ˆæœªæ¥ï¼‰ï¼š
```typescript
interface SyncHistoryData {
  records: SyncHistoryRecord[];
  maxRecords: number;  // å¯åœ¨è®¾ç½®ä¸­é…ç½®
  lastUpdated: number;
}
```

---

## æ€»ç»“

### æ•°æ®å­˜å‚¨ä½ç½®

| æ•°æ® | å­˜å‚¨æ–‡ä»¶ | å­˜å‚¨æ–¹å¼ | ä½œç”¨åŸŸ | è·¨è®¾å¤‡åŒæ­¥ |
|------|---------|---------|--------|-----------|
| è®¾å¤‡ ID | localStorage | æµè§ˆå™¨æœ¬åœ° | æµè§ˆå™¨ | âŒ ä¸åŒæ­¥ |
| Tab ID | sessionStorage | æµè§ˆå™¨æœ¬åœ° | å•ä¸ªTab | âŒ ä¸åŒæ­¥ |
| åŒæ­¥å†å² | sync-history.json | plugin.saveData | å…¨å±€ | âœ… éšæ€æºåŒæ­¥ |
| ç»Ÿè®¡æ•°æ® | sync-stats.json | plugin.saveData | å…¨å±€ | âœ… éšæ€æºåŒæ­¥ |
| ç¼“å­˜æ•°æ® | cache-*.json | plugin.saveData | å…¨å±€ | âœ… éšæ€æºåŒæ­¥ |

### å¤šç«¯ä¸€è‡´æ€§ä¿è¯

1. **è®°å½• ID å”¯ä¸€**ï¼š`{timestamp}-{deviceId}-{tabId}` æ ¼å¼é¿å…å†²çª
2. **Tab ä¼šè¯éš”ç¦»**ï¼šåŒä¸€æµè§ˆå™¨çš„ä¸åŒTabæœ‰ç‹¬ç«‹æ ‡è¯†
3. **åˆ†å¸ƒå¼é”**ï¼šé˜²æ­¢åŒæ—¶åŒæ­¥ï¼Œé™ä½æ•°æ®ç«äº‰
4. **åŠ è½½åæ·»åŠ **ï¼šæ¯æ¬¡å†™å…¥å‰å…ˆåŠ è½½æœ€æ–°æ•°æ®

### ä½¿ç”¨å»ºè®®

1. **å¯ç”¨åˆ†å¸ƒå¼é”**ï¼šç¡®ä¿ `syncLock.enabled = true`
2. **åˆç†è®¾ç½®é—´éš”**ï¼šå»ºè®® 10-30 åˆ†é’Ÿï¼Œé¿å…è¿‡äºé¢‘ç¹
3. **å®šæœŸæŸ¥çœ‹å†å²**ï¼šç›‘æ§åŒæ­¥çŠ¶æ€ï¼Œå‘ç°å¼‚å¸¸
4. **æ¸…ç†å†å²**ï¼šå¦‚éœ€é‡ç½®ç»Ÿè®¡ï¼Œå¯ä½¿ç”¨ "Clear History" åŠŸèƒ½
5. **æ³¨æ„ Tab ç¼–å·**ï¼šæµè§ˆå™¨è®¿é—®æ—¶ï¼Œæ¯ä¸ªæ–°Tabä¼šåˆ†é…é€’å¢ç¼–å·

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0
**æœ€åæ›´æ–°**: 2026-01-24
**ä½œè€…**: Claude Code
